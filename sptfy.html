<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Spotify Player</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling using monospace font and dark theme */
        body {
            font-family: monospace;
            background-color: #121212; /* Dark background */
            color: #b3b3b3; /* Light grey text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        /* Styling for buttons */
        button {
            background: none;
            border: 1px solid #b3b3b3;
            color: #b3b3b3;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px; /* Slightly rounded corners */
            vertical-align: middle; /* Align buttons and inputs */
            transition: all 0.2s ease; /* Smooth hover effect */
        }
        button:hover {
            border-color: #ffffff;
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1); /* Subtle background on hover */
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Styling for text input fields */
        input[type="text"] {
            background-color: #282828;
            border: 1px solid #535353;
            color: #ffffff;
            padding: 5px 8px;
            font-family: monospace;
            border-radius: 4px;
            margin: 5px;
            min-width: 250px; /* Give input some width */
            vertical-align: middle; /* Align with buttons */
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #b3b3b3;
        }
        /* Styling for the track info display */
        .track-info {
            margin-top: 20px;
            min-height: 40px; /* Reserve space */
            font-size: 1.1em;
        }
        /* Styling for error messages */
        .error-message {
            color: #f56565; /* Red color for errors */
            margin-top: 15px;
            min-height: 1.2em; /* Reserve space for errors */
        }
        /* Styling for informational messages */
        .info-message {
            color: #a0aec0; /* Lighter grey for info */
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* Styling for sections like Client ID input */
        .input-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #535353;
            border-radius: 4px;
        }
        /* Styling for the access token footer */
        .token-footer {
            margin-top: 25px;
            font-size: 0.8em;
            color: #535353; /* Faded color */
            word-break: break-all; /* Allow long token to wrap */
            padding: 5px;
            border-top: 1px solid #282828; /* Subtle separator */
        }
        /* Styling for refresh button (kept in case needed, but less critical now) */
        #refresh-button {
            font-size: 0.8em;
            padding: 3px 6px;
            margin-left: 10px;
            display: none; /* Hide by default, less needed with Playback SDK events */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-xl mb-4">[ Cade's Minimal Player ]</h1> 
        
        
        <div id="login-section">
            <div class="input-section client-id-section">
                <label for="client-id-input" class="block mb-1">1. Spotify Client ID:</label>
                <input type="text" id="client-id-input" placeholder="Enter your Spotify Client ID">
                <button id="save-client-id-button" title="Save Client ID to browser storage">[ Save ID ]</button>
                <button id="clear-client-id-button" title="Clear saved Client ID">[ Clear ]</button>
                <p id="client-id-status" class="info-message"></p>
            </div>

            <div class="input-section access-token-section">
                <label for="access-token-input" class="block mb-1">2. Access Token (Optional):</label>
                <input type="text" id="access-token-input" placeholder="Enter existing Access Token (optional)">
                 <p class="info-message">If provided, login uses this token & skips Spotify redirect.</p>
            </div>

            <p class="mb-2" id="login-prompt">Enter Client ID (and optionally Access Token), then Login.</p>
            <button id="login-button">[ Login / Connect Player ]</button>
            <p class="text-xs mt-2">(Requires Spotify Premium for playback)</p> 
        </div>

        
        <div id="player-section" style="display: none;">
            <div class="controls">
                <button id="prev-button" title="Previous Track" disabled>[ Prev ]</button>
                <button id="play-pause-button" title="Play/Pause" disabled>[ Play ]</button>
                <button id="next-button" title="Next Track" disabled>[ Next ]</button>
                <button id="refresh-button" title="Refresh playback state">[ Refresh API State ]</button> 
            </div>
            <div id="track-info" class="track-info">
                Initializing Player...
            </div>
            <div id="device-info" class="text-sm mt-2"> 
                Player Device: <span id="device-name">N/A</span> (<span id="device-id">N/A</span>)
            </div>
            <div id="token-footer" class="token-footer">
                Access Token: N/A
            </div>
        </div>

        
        <div id="error-message" class="error-message"></div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js/src/spotify-web-api.js"></script> 
    
    <script src="https://sdk.scdn.co/spotify-player.js"></script> 
    <script>
        // --- Configuration ---
        let clientId = null;
        const CLIENT_ID_STORAGE_KEY = 'spotifyMinimalPlayerClientId';
        const redirectUri = 'https://cadezawacki.github.io/sptfy.html'; // MUST match Spotify Dashboard
        const spotifyAuthorizeUrl = 'https://accounts.spotify.com/authorize'; 

        // Scopes needed for playback and control
        const scopes = [
            'streaming', // Needed for Web Playback SDK
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',    // Read playback state (useful for API fallback/initial state)
            'user-modify-playback-state'   // Control playback (both SDK and API)
        ].join(' ');

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const playerSection = document.getElementById('player-section');
        const loginButton = document.getElementById('login-button');
        const prevButton = document.getElementById('prev-button');
        const playPauseButton = document.getElementById('play-pause-button');
        const nextButton = document.getElementById('next-button');
        const refreshButton = document.getElementById('refresh-button');
        const trackInfoDiv = document.getElementById('track-info');
        const deviceInfoDiv = document.getElementById('device-info');
        const deviceNameSpan = document.getElementById('device-name');
        const deviceIdSpan = document.getElementById('device-id'); // Using this for Player SDK Device ID
        const errorMessageDiv = document.getElementById('error-message');
        const clientIdInput = document.getElementById('client-id-input');
        const saveClientIdButton = document.getElementById('save-client-id-button');
        const clearClientIdButton = document.getElementById('clear-client-id-button');
        const clientIdStatus = document.getElementById('client-id-status');
        const loginPrompt = document.getElementById('login-prompt');
        const accessTokenInput = document.getElementById('access-token-input');
        const tokenFooterDiv = document.getElementById('token-footer');

        // --- Global Variables ---
        let spotifyApi = null; // spotify-web-api-js instance
        let player = null; // Spotify.Player instance (Playback SDK)
        let currentAccessToken = null;
        let localPlayerDeviceId = null; // Device ID for the browser player
        let isPlayerReady = false; // Flag for Playback SDK player readiness
        let isSdkReady = false; // Flag if the Playback SDK script itself has loaded
        let pendingInitializationToken = null; // Token waiting for SDK script to load

        // --- Functions ---

        function displayError(message, isWarning = false) {
            console.error(isWarning ? "Warning:" : "Error:", message);
            errorMessageDiv.textContent = `${isWarning ? 'Warning' : 'Error'}: ${message}`;
            errorMessageDiv.style.color = isWarning ? '#ecc94b' : '#f56565';
        }

        function clearError() {
            errorMessageDiv.textContent = '';
        }

        function updateClientIdStatus(message, isError = false) {
            clientIdStatus.textContent = message;
            clientIdStatus.style.color = isError ? '#f56565' : '#a0aec0';
        }

        function updateTokenFooter(token) {
            if (token) {
                tokenFooterDiv.textContent = `Access Token: ${token}`;
            } else {
                tokenFooterDiv.textContent = 'Access Token: N/A';
            }
        }

        function loadClientId() {
            try {
                const savedId = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
                if (savedId) {
                    clientId = savedId;
                    clientIdInput.value = savedId;
                    updateClientIdStatus(`Loaded saved Client ID.`);
                    loginPrompt.textContent = "Client ID loaded. Enter optional token or Login.";
                    return true;
                } else {
                    updateClientIdStatus("No Client ID saved. Please enter and save.");
                    loginPrompt.textContent = "Please enter and save your Client ID, then login.";
                    return false;
                }
            } catch (e) {
                // Handle storage access errors
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to load Client ID.");
                updateClientIdStatus("Could not load Client ID from storage.", true);
                return false;
            }
        }

        function saveClientId() {
            const enteredId = clientIdInput.value.trim();
            if (!enteredId) {
                updateClientIdStatus("Client ID cannot be empty.", true);
                return false;
            }
            try {
                localStorage.setItem(CLIENT_ID_STORAGE_KEY, enteredId);
                clientId = enteredId;
                updateClientIdStatus("Client ID saved successfully.");
                loginPrompt.textContent = "Client ID saved. Enter optional token or Login.";
                clearError();
                return true;
            } catch (e) {
                // Handle storage access errors
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to save Client ID.");
                updateClientIdStatus("Failed to save Client ID to storage.", true);
                return false;
            }
        }

        function clearClientId() {
             try {
                localStorage.removeItem(CLIENT_ID_STORAGE_KEY);
                clientId = null;
                clientIdInput.value = '';
                updateClientIdStatus("Saved Client ID cleared.");
                loginPrompt.textContent = "Please enter and save your Client ID, then login.";
                clearError();
            } catch (e) {
                // Handle storage access errors
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to clear Client ID.");
                updateClientIdStatus("Failed to clear Client ID from storage.", true);
            }
        }

        /**
         * Updates the UI based primarily on the Web Playback SDK's state.
         * @param {object | null} state - The state object from Spotify.Player's player_state_changed event.
         */
        function updatePlayerUI(state) {
             if (!isPlayerReady || !state) {
                // Player not ready or state is null (disconnected?)
                trackInfoDiv.textContent = isPlayerReady ? "Player Ready. Select in Spotify or start playback." : "Player offline or initializing...";
                playPauseButton.textContent = '[ Play ]';
                playPauseButton.disabled = !isPlayerReady; // Only enable play if player is ready
                prevButton.disabled = true;
                nextButton.disabled = true;
                // Update device info even if state is null, if player is ready
                deviceNameSpan.textContent = player ? player._options.name : 'N/A';
                deviceIdSpan.textContent = localPlayerDeviceId || 'N/A';
                return;
            }

            // --- Player is ready and has state ---
            const track = state.track_window.current_track;
            const isPlaying = !state.paused;

            // Device Info (already set mostly)
            deviceNameSpan.textContent = player._options.name;
            deviceIdSpan.textContent = localPlayerDeviceId;

            // Track Info
            if (track) {
                const artists = track.artists.map(artist => artist.name).join(', ');
                trackInfoDiv.textContent = `${artists} - ${track.name}`;
            } else {
                trackInfoDiv.textContent = "No track loaded.";
            }

            // Controls State
            playPauseButton.textContent = isPlaying ? '[ Pause ]' : '[ Play ]';
            playPauseButton.disabled = false; // Enable controls now that we have state

            // Use SDK state for prev/next availability
            prevButton.disabled = !state.track_window.previous_tracks.length;
            nextButton.disabled = !state.track_window.next_tracks.length;
        }

        /**
         * Fetches playback state using the Web API (spotify-web-api-js).
         * Primarily useful for getting initial state or state of other devices.
         * NOTE: This state might differ from the local player's state if playback is elsewhere.
         */
        async function fetchApiPlaybackState() {
            if (!spotifyApi) {
                // displayError("API client not initialized.", true); // Maybe just log this
                console.warn("API client not initialized for fetchApiPlaybackState.");
                return null; // Return null if API not ready
            }
            console.log("Fetching playback state via API...");
            // clearError(); // Don't clear errors here, might overwrite player errors

            try {
                const state = await spotifyApi.getMyCurrentPlaybackState();
                console.log('API Playback state received:', state);
                return state; // Return the fetched state
            } catch (error) {
                console.error("Error fetching API playback state:", error);
                if (error.status === 401) {
                    displayError(`API Auth error: ${error.message || 'Token may be expired.'}. Please login again.`);
                    showLogin(); // Force re-login if token is bad for API
                } else {
                    // Don't necessarily show error in main div, could conflict with player status
                    console.error(`Failed to fetch API playback state: ${error.message || error}`);
                }
                return null; // Return null on error
            }
        }


        /**
         * Initializes the Spotify API client (spotify-web-api-js).
         * @param {string} token - The Spotify Access Token.
         */
        function initializeApiClient(token) {
             if (!token) {
                console.warn("Cannot initialize API client: Access token is missing.");
                return; // Don't show error, might be intentional if only player is needed initially
            }
             // Avoid re-initializing if already done with the same token
             if (spotifyApi && currentAccessToken === token) {
                 console.log("API client already initialized with this token.");
                 return;
             }

            currentAccessToken = token; // Update token even if re-initializing
            console.log("Initializing Spotify Web API client...");
            try {
                 spotifyApi = new SpotifyWebApi();
                 spotifyApi.setAccessToken(currentAccessToken);
                 console.log("API client initialized and token set.");
                 updateTokenFooter(currentAccessToken);
                 // Optionally fetch initial API state - but player state might be more relevant soon
                 // fetchApiPlaybackState().then(apiState => {
                 //    if (!isPlayerReady && apiState) { /* Maybe update UI if player isn't ready? */ }
                 // });
            } catch (e) {
                 console.error("Failed to instantiate SpotifyWebApi:", e);
                 displayError("Failed to load Spotify API library. Check console.");
                 // Don't necessarily force logout, player might still work
            }
        }

        /**
         * Initializes the Spotify Web Playback SDK Player.
         * This is called by window.onSpotifyWebPlaybackSDKReady or when token becomes available later.
         */
        function initializeSpotifyPlayer(token) {
            if (!token) {
                displayError("Cannot initialize player: Access token is missing.");
                showLogin(); // Player needs token
                return;
            }
             if (!isSdkReady) {
                 console.log("SDK script not ready yet, deferring player initialization.");
                 pendingInitializationToken = token; // Store token for later
                 return;
             }
             if (player) {
                console.log("Player already exists. Disconnecting previous instance.");
                isPlayerReady = false; // Mark as not ready while disconnecting
                player.disconnect();
                player = null; // Ensure old reference is cleared
            }

            console.log("Initializing Spotify Player instance...");
            trackInfoDiv.textContent = "Initializing Player...";
            updateTokenFooter(token); // Ensure footer shows the token being used

            // Create the player instance
            player = new Spotify.Player({
                name: 'Minimal Web Player', // Unique name
                getOAuthToken: cb => {
                    // Provide the token to the SDK when requested
                    console.log("Playback SDK requesting OAuth token.");
                    // You might add token refresh logic here in a real app
                    cb(currentAccessToken); // Provide the current token
                },
                volume: 0.5 // Default volume
            });

            // --- Player Event Listeners ---
            player.addListener('initialization_error', ({ message }) => {
                displayError(`Player Init failed: ${message}. Check Premium status, browser settings (DRM), and console.`);
                showLogin(); // Go back to login on critical init error
            });
            player.addListener('authentication_error', ({ message }) => {
                displayError(`Player Auth failed: ${message}. Token might be expired or invalid.`);
                currentAccessToken = null; // Token is bad for player
                showLogin(); // Force re-login
            });
            player.addListener('account_error', ({ message }) => {
                displayError(`Player Account error: ${message}. Spotify Premium required.`);
                // Don't force logout, user might fix it
            });
            player.addListener('playback_error', ({ message }) => {
                displayError(`Player Playback error: ${message}. Content might be restricted.`, true); // Show as warning
            });

            // State changes (track change, play/pause, etc.) - PRIMARY UI UPDATE SOURCE
            player.addListener('player_state_changed', (state) => {
                console.log('Player state changed:', state);
                if (!state) {
                    // State is null if player disconnects or has an issue
                    console.warn("Player state is null. Player may have disconnected.");
                    isPlayerReady = false; // Mark as not ready if state is null
                    // Optionally try to reconnect or show specific message
                }
                // Update UI based on the player's state
                updatePlayerUI(state);
            });

            // Player is ready to accept commands
            player.addListener('ready', ({ device_id }) => {
                console.log('Player ready with Device ID:', device_id);
                localPlayerDeviceId = device_id; // Store the local device ID
                isPlayerReady = true;
                trackInfoDiv.textContent = "Player Ready. Select this device ('Minimal Web Player') in Spotify app.";
                updatePlayerUI(null); // Update UI elements like device info span
                // You could automatically transfer playback here if desired:
                // transferPlaybackToLocalPlayer();
            });

            // Player is not ready (e.g., disconnected)
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Player device ID has gone offline:', device_id);
                if (localPlayerDeviceId === device_id) { // Check if it's our player
                    localPlayerDeviceId = null;
                    isPlayerReady = false;
                    displayError("Player has gone offline.", true);
                    updatePlayerUI(null); // Update UI to reflect offline state
                }
            });

            // --- Connect the Player ---
            player.connect().then(success => {
                if (success) {
                    console.log('Web Playback SDK successfully connected!');
                    trackInfoDiv.textContent = "Connected. Waiting for player ready...";
                } else {
                     console.error('Web Playback SDK failed to connect.');
                     displayError("Failed to connect the SDK. Check console (e.g., active device limit, browser issues).");
                     // Don't force logout immediately, might be temporary
                }
            }).catch(error => {
                 console.error('Error connecting player:', error);
                 displayError(`Player Connection error: ${error.message || error}. Check console.`);
                 showLogin(); // Force logout on connection error
            });
        }

        /**
         * This function is called by the Spotify Playback SDK script once it's loaded.
         */
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log("Spotify Playback SDK Script Ready.");
            isSdkReady = true;
            // If initialization was pending because the SDK script wasn't loaded, start it now
            if (pendingInitializationToken) {
                console.log("SDK script is now ready, initializing player with pending token.");
                initializeSpotifyPlayer(pendingInitializationToken);
                pendingInitializationToken = null; // Clear the pending token
            }
        };


        /**
         * Handles the Spotify authentication redirect callback.
         */
        function handleAuthenticationCallback() {
            loadClientId(); // Ensure Client ID is loaded

            const params = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = params.get('access_token');
            const error = params.get('error');

            // Clear the hash from the URL
            if (window.location.hash) {
                 history.pushState("", document.title, window.location.pathname + window.location.search);
            }

            if (error) {
                displayError(`Authentication failed: ${error}`);
                showLogin();
                return;
            }

            if (accessToken) {
                console.log("Access Token received via redirect.");
                if (!clientId) {
                    displayError("Logged in via redirect, but Client ID is missing. Please save it again.");
                    showLogin();
                } else {
                    // Successfully authenticated via redirect
                    currentAccessToken = accessToken; // Store the token
                    showPlayer();
                    // Initialize BOTH the API client and the Playback SDK Player
                    initializeApiClient(currentAccessToken);
                    initializeSpotifyPlayer(currentAccessToken);
                }
            } else if (!currentAccessToken) {
                // No token in hash and no token provided directly earlier, show login
                showLogin();
            }
            // If currentAccessToken was set by direct input, this callback doesn't need to re-init
        }

        /**
         * Redirects the user to Spotify's login page for authorization.
         */
        function redirectToSpotifyLogin() {
            clearError();
            if (!clientId) {
                 displayError("Spotify Client ID is missing. Please enter and save it.");
                 updateClientIdStatus("Client ID is required before login.", true);
                 clientIdInput.focus();
                 return;
            }
            // Basic validation for redirect URI
            if (!redirectUri || redirectUri === 'YOUR_REDIRECT_URI' || !redirectUri.startsWith('http')) {
                displayError("Spotify Redirect URI is not configured correctly in the code.");
                console.error("Developer Error: Configure redirectUri variable properly.");
                return;
            }

            const authUrl = `${spotifyAuthorizeUrl}?${new URLSearchParams({
                response_type: 'token',
                client_id: clientId,
                scope: scopes, // Use updated scopes including 'streaming'
                redirect_uri: redirectUri,
            })}`;

            console.log(`Redirecting to Spotify login with Client ID: ${clientId}`);
            window.location.href = authUrl;
        }

       /**
         * Initiates the login process based on user input.
         * Initializes Player and API client if token is provided, otherwise redirects.
         */
        function initiateLogin() {
            clearError();
            const enteredClientId = clientIdInput.value.trim();
            const enteredAccessToken = accessTokenInput.value.trim();

            // 1. Validate Client ID
            if (!enteredClientId) {
                displayError("Spotify Client ID is required.");
                updateClientIdStatus("Please enter your Client ID.", true);
                clientIdInput.focus();
                return;
            }
            // Save Client ID if it's different or not loaded
            if (enteredClientId !== clientId) {
                if (!saveClientId()) { return; } // saveClientId updates global `clientId`
            }

            // 2. Check for manually entered Access Token
            if (enteredAccessToken) {
                console.log("Attempting login with provided Access Token (skipping redirect).");
                currentAccessToken = enteredAccessToken; // Store the token
                showPlayer();
                // Initialize BOTH the API client and the Playback SDK Player
                initializeApiClient(currentAccessToken);
                initializeSpotifyPlayer(currentAccessToken);
            } else {
                // 3. No token provided, proceed with standard redirect flow
                console.log("No Access Token provided, redirecting for Spotify authorization.");
                redirectToSpotifyLogin(); // This redirect is necessary to get a token
            }
        }

        /**
         * Shows the login section and hides the player section. Cleans up player state.
         */
        function showLogin() {
            loginSection.style.display = 'block';
            playerSection.style.display = 'none';
            updateClientIdStatus(clientId ? "Client ID loaded." : "No Client ID saved.");
            updateTokenFooter(null);
            accessTokenInput.value = ''; // Clear token input
            currentAccessToken = null;
            spotifyApi = null; // Clear API instance
            isPlayerReady = false;
            localPlayerDeviceId = null;
            pendingInitializationToken = null;
            if (player) {
                console.log("Disconnecting player instance.");
                player.disconnect(); // Disconnect SDK player
                player = null;
            }
            updatePlayerUI(null); // Reset UI elements
        }

        /**
         * Shows the player section and hides the login section.
         */
        function showPlayer() {
            loginSection.style.display = 'none';
            playerSection.style.display = 'block';
            updateClientIdStatus(""); // Clear client ID status message
            clearError(); // Clear any login errors
            trackInfoDiv.textContent = "Initializing..."; // Initial message
        }


        // --- Event Listeners ---
        saveClientIdButton.addEventListener('click', saveClientId);
        clearClientIdButton.addEventListener('click', clearClientId);
        clientIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveClientId(); });
        loginButton.addEventListener('click', (e) => { e.preventDefault(); initiateLogin(); });
        refreshButton.addEventListener('click', fetchApiPlaybackState); // Keep for debugging API state

        // --- Player Controls (use SDK Player methods) ---
        playPauseButton.addEventListener('click', () => {
            if (!player || !isPlayerReady) return;
            clearError(); // Clear minor errors on interaction
            console.log("Toggling play/pause via SDK player...");
            player.togglePlay().catch(err => {
                 console.error("Toggle play error:", err);
                 displayError(`Toggle play failed: ${err.message || err}`);
            });
            // UI will update via the 'player_state_changed' listener
        });

        prevButton.addEventListener('click', () => {
            if (!player || !isPlayerReady) return;
            clearError();
            console.log("Skipping to previous via SDK player...");
            player.previousTrack().catch(err => {
                console.error("Previous track error:", err);
                displayError(`Previous track failed: ${err.message || err}`);
            });
            // UI will update via the 'player_state_changed' listener
        });

        nextButton.addEventListener('click', () => {
            if (!player || !isPlayerReady) return;
            clearError();
            console.log("Skipping to next via SDK player...");
            player.nextTrack().catch(err => {
                console.error("Next track error:", err);
                displayError(`Next track failed: ${err.message || err}`);
            });
             // UI will update via the 'player_state_changed' listener
        });

        // --- Initialization ---
        window.addEventListener('load', () => {
            loadClientId();
            // Check for token in URL hash from redirect
            // handleAuthenticationCallback will initialize player/api if token found
            handleAuthenticationCallback();
        });

    </script>
</body>
</html>
