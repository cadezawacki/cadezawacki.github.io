<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Spotify Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling using monospace font and dark theme */
        body {
            font-family: monospace;
            background-color: #121212; /* Dark background */
            color: #b3b3b3; /* Light grey text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        /* Styling for buttons and anchor tags acting as buttons */
        button, a.button-style {
            background: none;
            border: 1px solid #b3b3b3;
            color: #b3b3b3;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px; /* Slightly rounded corners */
            vertical-align: middle; /* Align buttons and inputs */
            transition: all 0.2s ease-in-out; /* Smooth hover effect */
        }
        button:hover, a.button-style:hover {
            border-color: #ffffff;
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1); /* Subtle background on hover */
        }
        /* Styling for disabled buttons */
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            border-color: #535353;
            color: #535353;
            background: none;
        }
        /* Styling for text inputs */
        input[type="text"] {
            background-color: #282828;
            border: 1px solid #535353;
            color: #ffffff;
            padding: 5px 8px;
            font-family: monospace;
            border-radius: 4px;
            margin: 5px;
            min-width: 250px; /* Give input some width */
            vertical-align: middle; /* Align with buttons */
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #b3b3b3;
        }
        /* Styling for the track info display */
        .track-info {
            margin-top: 20px;
            min-height: 40px; /* Reserve space */
            font-size: 1.1em;
        }
        /* Styling for error messages */
        .error-message {
            color: #f56565; /* Red color for errors */
            margin-top: 15px;
            min-height: 1.2em; /* Reserve space for errors */
        }
        /* Styling for informational messages */
        .info-message {
            color: #a0aec0; /* Lighter grey for info */
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* Styling for input sections */
        .input-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #535353;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-xl mb-4">[ Cade's Minimal Player ]</h1>

        <div id="login-section">
            <div class="input-section">
                <label for="client-id-input" class="block mb-1">1. Spotify Client ID:</label>
                <input type="text" id="client-id-input" placeholder="Enter your Spotify Client ID">
                <button id="save-client-id-button">[ Save ID ]</button>
                <button id="clear-client-id-button" title="Clear saved Client ID">[ Clear ]</button>
                <p id="client-id-status" class="info-message"></p>
            </div>

            <div class="input-section">
                <label for="access-token-input" class="block mb-1">2. Spotify Access Token:</label>
                <input type="text" id="access-token-input" placeholder="Login via Spotify or paste token">
                <p id="access-token-status" class="info-message">Login below to auto-fill.</p>
            </div>

            <p class="mb-2" id="login-prompt">Enter/Save Client ID, then either Login or paste Token, then click Go.</p>
            <a href="#" id="login-button" class="button-style">[ Login with Spotify ]</a>
            <button id="go-button" disabled>[ Go ]</button> <p class="text-xs mt-2">(Requires Spotify Premium)</p>
        </div>

        <div id="player-section" style="display: none;">
            <div class="controls">
                <button id="prev-button" title="Previous Track" disabled>[ Prev ]</button>
                <button id="play-pause-button" title="Play/Pause" disabled>[ Play ]</button>
                <button id="next-button" title="Next Track" disabled>[ Next ]</button>
            </div>
            <div id="track-info" class="track-info">
                Connecting...
            </div>
            <div id="device-info" class="text-sm mt-2">
                Device: <span id="device-name"></span> (<span id="device-id"></span>)
            </div>
             <button id="logout-button" class="mt-4">[ Logout / Change ID ]</button> </div>

        <div id="error-message" class="error-message"></div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // --- Configuration ---
        let clientId = null; // Will be loaded from localStorage or input
        const CLIENT_ID_STORAGE_KEY = 'spotifyMinimalPlayerClientId';
        // IMPORTANT: Replace with your actual Redirect URI registered in Spotify Dashboard
        const redirectUri = 'https://cadezawacki.github.io/sptfy.html';
        const scopes = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',
            'user-modify-playback-state'
        ].join(' ');

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const playerSection = document.getElementById('player-section');
        const loginButton = document.getElementById('login-button');
        const goButton = document.getElementById('go-button'); // New Go button
        const logoutButton = document.getElementById('logout-button'); // New Logout button
        const prevButton = document.getElementById('prev-button');
        const playPauseButton = document.getElementById('play-pause-button');
        const nextButton = document.getElementById('next-button');
        const trackInfoDiv = document.getElementById('track-info');
        const deviceInfoDiv = document.getElementById('device-info');
        const deviceNameSpan = document.getElementById('device-name');
        const deviceIdSpan = document.getElementById('device-id');
        const errorMessageDiv = document.getElementById('error-message');
        const clientIdInput = document.getElementById('client-id-input');
        const saveClientIdButton = document.getElementById('save-client-id-button');
        const clearClientIdButton = document.getElementById('clear-client-id-button');
        const clientIdStatus = document.getElementById('client-id-status');
        const accessTokenInput = document.getElementById('access-token-input'); // New Access Token input
        const accessTokenStatus = document.getElementById('access-token-status'); // New status for token
        const loginPrompt = document.getElementById('login-prompt');


        // --- Global Variables ---
        let player = null;
        let deviceId = null;
        let currentAccessToken = null; // Store the token used for initialization
        let isPlaying = false;

        // --- Functions ---

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            console.error("Error:", message);
            errorMessageDiv.textContent = `Error: ${message}`;
        }

        /**
         * Clears any displayed error message.
         */
        function clearError() {
            errorMessageDiv.textContent = '';
        }

        /**
         * Updates the status message related to the Client ID.
         * @param {string} message - The message to display.
         * @param {boolean} isError - Optional: style as error if true.
         */
        function updateClientIdStatus(message, isError = false) {
            clientIdStatus.textContent = message;
            clientIdStatus.style.color = isError ? '#f56565' : '#a0aec0'; // Red for error, grey for info
        }

         /**
         * Updates the status message related to the Access Token.
         * @param {string} message - The message to display.
         */
        function updateAccessTokenStatus(message) {
            accessTokenStatus.textContent = message;
        }

        /**
         * Checks if both Client ID and Access Token inputs have values and enables/disables the Go button.
         */
        function checkInputsAndEnableGoButton() {
            const idValue = clientIdInput.value.trim();
            const tokenValue = accessTokenInput.value.trim();
            const canProceed = idValue && tokenValue;

            goButton.disabled = !canProceed;

            if (canProceed) {
                 loginPrompt.textContent = "Ready. Click [ Go ] to start the player.";
            } else if (!idValue && !tokenValue) {
                 loginPrompt.textContent = "Enter/Save Client ID, then Login or paste Token, then click Go.";
            } else if (!idValue) {
                 loginPrompt.textContent = "Client ID needed. Enter/Save Client ID, then click Go.";
            } else { // Only token missing
                 loginPrompt.textContent = "Access Token needed. Login via Spotify or paste Token, then click Go.";
            }
        }


        /**
         * Loads Client ID from Local Storage.
         */
        function loadClientId() {
            try {
                const savedId = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
                if (savedId) {
                    clientId = savedId; // Set global variable
                    clientIdInput.value = savedId;
                    updateClientIdStatus(`Loaded saved Client ID.`);
                    console.log("Client ID loaded from storage.");
                } else {
                    updateClientIdStatus("No Client ID saved. Please enter and save.");
                }
            } catch (e) {
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to load Client ID.");
                updateClientIdStatus("Could not load Client ID from storage.", true);
            }
            checkInputsAndEnableGoButton(); // Check button state after loading
        }

        /**
         * Saves Client ID to Local Storage.
         */
        function saveClientId() {
            const enteredId = clientIdInput.value.trim();
            if (!enteredId) {
                updateClientIdStatus("Client ID cannot be empty.", true);
                checkInputsAndEnableGoButton(); // Update button state
                return;
            }
            try {
                localStorage.setItem(CLIENT_ID_STORAGE_KEY, enteredId);
                clientId = enteredId; // Update the global variable
                updateClientIdStatus("Client ID saved successfully.");
                console.log("Client ID saved to storage.");
                clearError(); // Clear previous errors if save is successful
            } catch (e) {
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to save Client ID.");
                updateClientIdStatus("Failed to save Client ID to storage.", true);
            }
            checkInputsAndEnableGoButton(); // Check button state after saving
        }

        /**
         * Clears Client ID from Local Storage.
         */
        function clearClientId() {
             try {
                localStorage.removeItem(CLIENT_ID_STORAGE_KEY);
                clientId = null; // Clear the global variable
                clientIdInput.value = ''; // Clear the input field
                updateClientIdStatus("Saved Client ID cleared.");
                console.log("Client ID cleared from storage.");
                clearError();
            } catch (e) {
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to clear Client ID.");
                updateClientIdStatus("Failed to clear Client ID from storage.", true);
            }
            checkInputsAndEnableGoButton(); // Check button state after clearing
        }


        /**
         * Updates the UI with the current track information.
         * @param {object} state - The playback state object from the Spotify SDK.
         */
        function updateUI(state) {
            // (Function content remains the same as before)
             if (!state) {
                trackInfoDiv.textContent = "Player offline or no track loaded.";
                playPauseButton.textContent = '[ Play ]';
                playPauseButton.disabled = true;
                prevButton.disabled = true;
                nextButton.disabled = true;
                isPlaying = false;
                return;
            }

            const track = state.track_window.current_track;
            isPlaying = !state.paused;

            if (track) {
                const artists = track.artists.map(artist => artist.name).join(', ');
                trackInfoDiv.textContent = `${artists} - ${track.name}`;
            } else {
                trackInfoDiv.textContent = "No track loaded.";
            }

            playPauseButton.textContent = isPlaying ? '[ Pause ]' : '[ Play ]';
            playPauseButton.disabled = false; // Enable once state is received

            prevButton.disabled = !state.track_window.previous_tracks.length;
            nextButton.disabled = !state.track_window.next_tracks.length;

            // Use player._options.name if player exists, otherwise 'N/A'
            deviceNameSpan.textContent = player?._options?.name ?? 'N/A';
            deviceIdSpan.textContent = deviceId || 'N/A';
        }

        /**
         * Handles the Spotify authentication redirect. Populates token field but doesn't start player.
         */
        function handleAuthentication() {
            loadClientId(); // Try to load Client ID first

            const params = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = params.get('access_token');
            const error = params.get('error');

            if (error) {
                displayError(`Authentication failed: ${error}`);
                showLogin(); // Stay on login page
                return;
            }

            if (accessToken) {
                console.log("Access Token received from redirect.");
                accessTokenInput.value = accessToken; // Populate the input field
                updateAccessTokenStatus("Token populated from login.");
                window.location.hash = ''; // Clear hash from URL
                checkInputsAndEnableGoButton(); // Enable Go button if Client ID is also present
                showLogin(); // Stay on the login page, DO NOT proceed automatically
            } else {
                // No token in hash, just show login section (normal page load)
                showLogin();
            }
        }

        /**
         * Redirects the user to Spotify's login page.
         */
        function redirectToSpotifyLogin() {
            clearError(); // Clear previous errors

            // Re-check and ensure Client ID is saved/set before redirecting
            const currentClientId = clientIdInput.value.trim();
             if (!currentClientId) {
                 // Try saving what's in the input first
                 saveClientId();
                 // Check again if it was successfully saved and set globally
                 if (!clientId) {
                    displayError("Spotify Client ID is missing or couldn't be saved. Please enter and save it first.");
                    updateClientIdStatus("Client ID is required before login.", true);
                    clientIdInput.focus(); // Focus the input field
                    return;
                 }
             } else if (currentClientId !== clientId) {
                 // If input has changed since load/save, re-save it
                 saveClientId();
                 if (!clientId) return; // Exit if save failed
             }


             // Check redirect URI
             if (!redirectUri || redirectUri === 'YOUR_REDIRECT_URI') {
                 displayError("Spotify Redirect URI is not configured in the code.");
                 alert("Developer Error: Please configure the Spotify Redirect URI in the HTML file's code.");
                 return;
             }

             // Construct the auth URL with the current clientId
             // Note: Using a proxy URL like googleusercontent.com might be necessary in some environments
             // to bypass CORS issues, but the standard URL is accounts.spotify.com.
             // Adjust if needed, but ensure the proxy is reliable or use the standard URL.
             const authUrl = `https://accounts.spotify.com/authorize?${new URLSearchParams({
                 response_type: 'token',
                 client_id: clientId, // Use the confirmed clientId
                 scope: scopes,
                 redirect_uri: redirectUri,
             })}`;

             console.log(`Redirecting to Spotify login with Client ID: ${clientId}`);
             window.location.href = authUrl;
        }

        /**
         * Shows the login section and hides the player.
         */
        function showLogin() {
            loginSection.style.display = 'block';
            playerSection.style.display = 'none';
            // Reset player state if returning to login
             if (player) {
                player.disconnect();
                player = null;
                console.log("Disconnected player.");
            }
            deviceId = null;
            currentAccessToken = null;
            updateClientIdStatus(clientId ? "Loaded saved Client ID." : "No Client ID saved."); // Refresh status
            accessTokenInput.value = ''; // Clear token input when showing login
            updateAccessTokenStatus("Login via Spotify or paste token.");
            checkInputsAndEnableGoButton(); // Ensure Go button is correctly disabled/enabled
        }

        /**
         * Shows the player section and hides the login section.
         */
        function showPlayer() {
            loginSection.style.display = 'none';
            playerSection.style.display = 'block';
             // Clear messages relevant only to login screen
             updateClientIdStatus("");
             updateAccessTokenStatus("");
             loginPrompt.textContent = ""; // Clear main prompt
        }

        /**
         * Initializes the Spotify Web Playback SDK Player.
         * This function is called by the SDK script once loaded.
         */
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log("Spotify SDK Ready.");
            // Initialization logic is now triggered by the 'Go' button click
        };

        /**
         * Creates and connects the Spotify Player instance using the token from the input field.
         */
        function initializeAndConnectPlayer() {
            clearError();
            const token = accessTokenInput.value.trim();
            const id = clientIdInput.value.trim();

            if (!token || !id) {
                displayError("Client ID and Access Token are required to start.");
                showLogin(); // Go back if somehow called without both
                return;
            }

            // Update global variables just before initializing
            currentAccessToken = token;
            clientId = id; // Ensure global clientId matches input used

            if (player) {
                console.log("Player already exists. Disconnecting previous instance.");
                player.disconnect();
            }

             console.log("Initializing Spotify Player with provided token...");
             trackInfoDiv.textContent = "Initializing Player...";

             player = new Spotify.Player({
                 name: 'Minimal Web Player',
                 getOAuthToken: cb => { cb(currentAccessToken); }, // Use the current token
                 volume: 0.5
             });

             // --- Player Event Listeners ---
             player.addListener('initialization_error', ({ message }) => {
                 displayError(`Initialization failed: ${message}. Ensure Spotify Premium and check console.`);
                 showLogin(); // Go back to login on critical error
             });
             player.addListener('authentication_error', ({ message }) => {
                 displayError(`Authentication failed: ${message}. Token might be expired or invalid.`);
                 currentAccessToken = null; // Invalidate token
                 accessTokenInput.value = ''; // Clear invalid token
                 showLogin(); // Force back to login
             });
             player.addListener('account_error', ({ message }) => {
                 displayError(`Account error: ${message}. Spotify Premium might be required.`);
                 // Don't necessarily go back to login, maybe user can fix account issue
             });
             player.addListener('playback_error', ({ message }) => {
                 displayError(`Playback error: ${message}. Content might be restricted.`);
             });

             player.addListener('player_state_changed', (state) => {
                 console.log('Player state changed:', state);
                 clearError(); // Clear previous errors on successful state change
                 if (!state) {
                     // This can happen if the player disconnects or Spotify is closed elsewhere
                     console.warn("Player state received as null.");
                     // Optionally display a message or attempt reconnect, but for now just update UI
                     updateUI(null);
                     // Avoid showing a persistent error if it's just a temporary disconnect
                     // displayError("Player state is null. Disconnected or issue occurred.");
                     return;
                 }
                 deviceId = state.device_id; // Update device ID
                 updateUI(state); // Update track info, buttons, etc.
             });

             player.addListener('ready', ({ device_id }) => {
                 console.log('Player ready with Device ID', device_id);
                 deviceId = device_id;
                 trackInfoDiv.textContent = "Player Ready. Select this device ('Minimal Web Player') in Spotify.";
                 updateUI(null); // Update device info display
                 // Optionally transfer playback automatically (can be annoying, leave commented for now)
                 // transferPlayback(device_id);
             });

             player.addListener('not_ready', ({ device_id }) => {
                 console.log('Device ID has gone offline', device_id);
                 // Only clear our deviceId if it matches the one that went offline
                 if (deviceId === device_id) {
                    deviceId = null;
                    displayError("Player device has gone offline.");
                    updateUI(null); // Reset UI elements
                 }
             });

             // --- Connect the Player ---
             player.connect().then(success => {
                 if (success) {
                     console.log('Web Playback SDK successfully connected!');
                     trackInfoDiv.textContent = "Connected. Waiting for player ready...";
                 } else {
                      console.error('Web Playback SDK failed to connect.');
                      displayError("Failed to connect the SDK. Check browser console.");
                      showLogin(); // Go back to login on connection failure
                 }
             }).catch(error => {
                  console.error('Error connecting player:', error);
                  displayError(`Connection error: ${error.message || error}`);
                  showLogin(); // Go back to login on connection error
             });
        }

        /**
         * Transfers playback to this web player. (Unchanged)
         * @param {string} targetDeviceId - The device ID of this web player.
         */
        async function transferPlayback(targetDeviceId) {
             // (Function content remains the same as before)
             if (!currentAccessToken || !targetDeviceId) {
                 console.warn("Cannot transfer playback: Missing token or device ID.");
                 return;
             }
             try {
                 // Note: Using googleusercontent proxy might be needed, adjust if required.
                 // Standard endpoint: https://api.spotify.com/v1/me/player
                 const response = await fetch('https://api.spotify.com/v1/me/player', {
                     method: 'PUT',
                     headers: {
                         'Authorization': `Bearer ${currentAccessToken}`,
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify({
                         device_ids: [targetDeviceId],
                         play: false // Set to true to start playing immediately after transfer
                     }),
                 });
                 if (!response.ok) {
                    throw new Error(`Spotify API Error: ${response.status} ${response.statusText}`);
                 }
                 console.log(`Playback transfer requested to device ${targetDeviceId}`);
             } catch (error) {
                 displayError(`Failed to transfer playback: ${error.message}`);
                 console.error("Error transferring playback:", error);
             }
        }


        // --- Event Listeners ---
        saveClientIdButton.addEventListener('click', saveClientId);
        clearClientIdButton.addEventListener('click', clearClientId);

        // Update Go button state when inputs change
        clientIdInput.addEventListener('input', checkInputsAndEnableGoButton);
        accessTokenInput.addEventListener('input', checkInputsAndEnableGoButton);

        // Optional: Save Client ID when pressing Enter in the input field
        clientIdInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                saveClientId();
            }
        });

        // Login button initiates the Spotify auth flow
        loginButton.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default anchor behavior
            redirectToSpotifyLogin();
        });

        // Go button switches view and initializes the player
        goButton.addEventListener('click', () => {
            showPlayer();
            initializeAndConnectPlayer();
        });

         // Logout button disconnects player and returns to login screen
        logoutButton.addEventListener('click', () => {
            console.log("Logout clicked.");
            showLogin(); // This function now handles disconnect and state reset
        });


        // Player control buttons
        playPauseButton.addEventListener('click', () => {
            if (!player) return;
            player.togglePlay().catch(err => displayError(`Toggle play failed: ${err.message}`));
        });

        prevButton.addEventListener('click', () => {
            if (!player) return;
            player.previousTrack().catch(err => displayError(`Previous track failed: ${err.message}`));
        });

        nextButton.addEventListener('click', () => {
            if (!player) return;
            player.nextTrack().catch(err => displayError(`Next track failed: ${err.message}`));
        });

        // --- Initialization ---
        // Load Client ID and check for access token in hash on page load
        window.addEventListener('load', handleAuthentication);

    </script>
</body>
</html>
