<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Spotify Player</title>
    
    

<script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: monospace;
            background-color: #121212; /* Dark background */
            color: #b3b3b3; /* Light grey text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        button, a.button-style { /* Apply button style to anchors acting as buttons */
            background: none;
            border: 1px solid #b3b3b3;
            color: #b3b3b3;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px; /* Slightly rounded corners */
            vertical-align: middle; /* Align buttons and inputs */
        }
        button:hover, a.button-style:hover {
            border-color: #ffffff;
            color: #ffffff;
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        input[type="text"] {
            background-color: #282828;
            border: 1px solid #535353;
            color: #ffffff;
            padding: 5px 8px;
            font-family: monospace;
            border-radius: 4px;
            margin: 5px;
            min-width: 250px; /* Give input some width */
            vertical-align: middle; /* Align with buttons */
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #b3b3b3;
        }
        .track-info {
            margin-top: 20px;
            min-height: 40px; /* Reserve space */
            font-size: 1.1em;
        }
        .error-message {
            color: #f56565; /* Red color for errors */
            margin-top: 15px;
            min-height: 1.2em; /* Reserve space for errors */
        }
        .info-message {
            color: #a0aec0; /* Lighter grey for info */
            font-size: 0.9em;
            margin-top: 5px;
        }
        .client-id-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #535353;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-xl mb-4">[ Cade's Minimal Player ]</h1>

        
        

<div id="login-section">
            <div class="client-id-section">
                <label for="client-id-input" class="block mb-1">Spotify Client ID:</label>
                <input type="text" id="client-id-input" placeholder="Enter your Spotify Client ID">
                <button id="save-client-id-button">[ Save ID ]</button>
                <button id="clear-client-id-button" title="Clear saved Client ID">[ Clear ]</button>
                <p id="client-id-status" class="info-message"></p>
            </div>

            <p class="mb-2" id="login-prompt">Please save your Client ID above, then login.</p>
            <a href="#" id="login-button" class="button-style">[ Login with Spotify ]</a>
            <p class="text-xs mt-2">(Requires Spotify Premium)</p>
        </div>

        
        

<div id="player-section" style="display: none;">
            <div class="controls">
                <button id="prev-button" title="Previous Track" disabled>[ Prev ]</button>
                <button id="play-pause-button" title="Play/Pause" disabled>[ Play ]</button>
                <button id="next-button" title="Next Track" disabled>[ Next ]</button>
            </div>
            <div id="track-info" class="track-info">
                Connecting...
            </div>
            <div id="device-info" class="text-sm mt-2">
                Device: <span id="device-name"></span> (<span id="device-id"></span>)
            </div>
        </div>
        
        
        

<div id="error-message" class="error-message"></div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // --- Configuration ---
        // Client ID will be loaded from localStorage or input
        let clientId = null;
        const CLIENT_ID_STORAGE_KEY = 'spotifyMinimalPlayerClientId';
        const redirectUri = 'https://cadezawacki.github.io/sptfy.html';
        const scopes = [
            'streaming',
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',
            'user-modify-playback-state'
        ].join(' ');

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const playerSection = document.getElementById('player-section');
        const loginButton = document.getElementById('login-button');
        const prevButton = document.getElementById('prev-button');
        const playPauseButton = document.getElementById('play-pause-button');
        const nextButton = document.getElementById('next-button');
        const trackInfoDiv = document.getElementById('track-info');
        const deviceInfoDiv = document.getElementById('device-info');
        const deviceNameSpan = document.getElementById('device-name');
        const deviceIdSpan = document.getElementById('device-id');
        const errorMessageDiv = document.getElementById('error-message');
        const clientIdInput = document.getElementById('client-id-input');
        const saveClientIdButton = document.getElementById('save-client-id-button');
        const clearClientIdButton = document.getElementById('clear-client-id-button');
        const clientIdStatus = document.getElementById('client-id-status');
        const loginPrompt = document.getElementById('login-prompt');


        // --- Global Variables ---
        let player = null;
        let deviceId = null;
        let currentAccessToken = null;
        let isPlaying = false;

        // --- Functions ---

        /**
         * Displays an error message to the user.
         * @param {string} message - The error message to display.
         */
        function displayError(message) {
            console.error("Error:", message);
            errorMessageDiv.textContent = `Error: ${message}`;
        }

        /**
         * Clears any displayed error message.
         */
        function clearError() {
            errorMessageDiv.textContent = '';
        }

        /**
         * Updates the status message related to the Client ID.
         * @param {string} message - The message to display.
         * @param {boolean} isError - Optional: style as error if true.
         */
        function updateClientIdStatus(message, isError = false) {
            clientIdStatus.textContent = message;
            clientIdStatus.style.color = isError ? '#f56565' : '#a0aec0'; // Red for error, grey for info
        }

        /**
         * Loads Client ID from Local Storage.
         */
        function loadClientId() {
            try {
                const savedId = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
                if (savedId) {
                    clientId = savedId;
                    clientIdInput.value = savedId;
                    updateClientIdStatus(`Loaded saved Client ID.`);
                    loginPrompt.textContent = "Client ID loaded. Please login.";
                    console.log("Client ID loaded from storage.");
                } else {
                    updateClientIdStatus("No Client ID saved. Please enter and save.");
                    loginPrompt.textContent = "Please enter and save your Client ID above, then login.";
                }
            } catch (e) {
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to load Client ID.");
                updateClientIdStatus("Could not load Client ID from storage.", true);
            }
        }

        /**
         * Saves Client ID to Local Storage.
         */
        function saveClientId() {
            const enteredId = clientIdInput.value.trim();
            if (!enteredId) {
                updateClientIdStatus("Client ID cannot be empty.", true);
                return;
            }
            try {
                localStorage.setItem(CLIENT_ID_STORAGE_KEY, enteredId);
                clientId = enteredId; // Update the global variable
                updateClientIdStatus("Client ID saved successfully.");
                loginPrompt.textContent = "Client ID saved. Please login.";
                console.log("Client ID saved to storage.");
                clearError(); // Clear previous errors if save is successful
            } catch (e) {
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to save Client ID.");
                updateClientIdStatus("Failed to save Client ID to storage.", true);
            }
        }

        /**
         * Clears Client ID from Local Storage.
         */
        function clearClientId() {
             try {
                localStorage.removeItem(CLIENT_ID_STORAGE_KEY);
                clientId = null; // Clear the global variable
                clientIdInput.value = ''; // Clear the input field
                updateClientIdStatus("Saved Client ID cleared.");
                loginPrompt.textContent = "Please enter and save your Client ID above, then login.";
                console.log("Client ID cleared from storage.");
                clearError();
            } catch (e) {
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to clear Client ID.");
                updateClientIdStatus("Failed to clear Client ID from storage.", true);
            }
        }


        /**
         * Updates the UI with the current track information.
         * @param {object} state - The playback state object from the Spotify SDK.
         */
        function updateUI(state) {
            // (Function content remains the same as before)
             if (!state) {
                trackInfoDiv.textContent = "Player offline or no track loaded.";
                playPauseButton.textContent = '[ Play ]';
                playPauseButton.disabled = true;
                prevButton.disabled = true;
                nextButton.disabled = true;
                isPlaying = false;
                return;
            }

            const track = state.track_window.current_track;
            isPlaying = !state.paused;

            if (track) {
                const artists = track.artists.map(artist => artist.name).join(', ');
                trackInfoDiv.textContent = `${artists} - ${track.name}`;
            } else {
                trackInfoDiv.textContent = "No track loaded.";
            }

            playPauseButton.textContent = isPlaying ? '[ Pause ]' : '[ Play ]';
            playPauseButton.disabled = false; // Enable once state is received

            prevButton.disabled = !state.track_window.previous_tracks.length;
            nextButton.disabled = !state.track_window.next_tracks.length;

            deviceNameSpan.textContent = player ? player._options.name : 'N/A';
            deviceIdSpan.textContent = deviceId || 'N/A';
        }

        /**
         * Handles the Spotify authentication redirect.
         */
        function handleAuthentication() {
            loadClientId(); // Try to load Client ID first

            const params = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = params.get('access_token');
            const error = params.get('error');

            if (error) {
                displayError(`Authentication failed: ${error}`);
                showLogin();
                return;
            }

            if (accessToken) {
                console.log("Access Token received.");
                currentAccessToken = accessToken;
                window.location.hash = ''; // Clear hash
                if (!clientId) {
                     // This case should ideally not happen if login was initiated correctly,
                     // but handle it defensively.
                     displayError("Logged in, but Client ID is missing. Please save it again.");
                     showLogin();
                } else {
                    showPlayer();
                    initializeSpotifyPlayer(accessToken);
                }
            } else {
                // No token in hash, show login section
                showLogin();
            }
        }

        /**
         * Redirects the user to Spotify's login page.
         */
        function redirectToSpotifyLogin() {
            clearError(); // Clear previous errors

            // Ensure Client ID is set (either loaded or just saved)
            if (!clientId) {
                 displayError("Spotify Client ID is missing. Please enter and save it above.");
                 updateClientIdStatus("Client ID is required before login.", true);
                 clientIdInput.focus(); // Focus the input field
                 return;
            }
             // Check redirect URI (still needs to be configured correctly)
             if (!redirectUri || redirectUri === 'YOUR_REDIRECT_URI') {
                 displayError("Spotify Redirect URI is not configured in the code.");
                 alert("Developer Error: Please configure the Spotify Redirect URI in the HTML file's code.");
                 return;
            }

            // Construct the auth URL with the current clientId
            const authUrl = `https://accounts.spotify.com/authorize?${new URLSearchParams({
                response_type: 'token',
                client_id: clientId, // Use the loaded/saved clientId
                scope: scopes,
                redirect_uri: redirectUri,
            })}`;

            console.log(`Redirecting to Spotify login with Client ID: ${clientId}`);
            window.location.href = authUrl;
        }

        /**
         * Shows the login section and hides the player.
         */
        function showLogin() {
            loginSection.style.display = 'block';
            playerSection.style.display = 'none';
        }

        /**
         * Shows the player section and hides the login section.
         */
        function showPlayer() {
            loginSection.style.display = 'none';
            playerSection.style.display = 'block';
             // Clear client ID status message when player is shown
             updateClientIdStatus("");
        }

        /**
         * Initializes the Spotify Web Playback SDK Player.
         * This function is called by the SDK script once loaded.
         */
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log("Spotify SDK Ready.");
            // Initialization logic is now triggered after authentication callback
            // if an access token is found.
        };

        /**
         * Creates and connects the Spotify Player instance.
         * @param {string} token - The Spotify Access Token.
         */
        function initializeSpotifyPlayer(token) {
             // (Function content remains largely the same as before)
             // It now relies on `currentAccessToken` which is set in handleAuthentication
            if (!token) {
                displayError("Cannot initialize player without an access token.");
                showLogin();
                return;
            }
            if (player) {
                console.log("Player already initialized. Disconnecting previous instance.");
                player.disconnect();
            }

             console.log("Initializing Spotify Player...");
             trackInfoDiv.textContent = "Initializing Player...";

            player = new Spotify.Player({
                name: 'Minimal Web Player',
                getOAuthToken: cb => { cb(token); }, // Use the token passed to the function
                volume: 0.5
            });

            // --- Player Event Listeners ---
            player.addListener('initialization_error', ({ message }) => {
                displayError(`Initialization failed: ${message}. Ensure Spotify Premium and check console.`);
                showLogin();
            });
            player.addListener('authentication_error', ({ message }) => {
                displayError(`Authentication failed: ${message}. Token might be expired or invalid.`);
                currentAccessToken = null;
                showLogin(); // Force re-login (will require Client ID check again)
            });
            player.addListener('account_error', ({ message }) => {
                displayError(`Account error: ${message}. Spotify Premium might be required.`);
            });
            player.addListener('playback_error', ({ message }) => {
                displayError(`Playback error: ${message}. Content might be restricted.`);
            });

            player.addListener('player_state_changed', (state) => {
                console.log('Player state changed:', state);
                clearError();
                if (!state) {
                    displayError("Player state is null. Disconnected or issue occurred.");
                    updateUI(null);
                    return;
                }
                deviceId = state.device_id;
                updateUI(state);
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Player ready with Device ID', device_id);
                deviceId = device_id;
                trackInfoDiv.textContent = "Player Ready. Select this device ('Minimal Web Player') in Spotify.";
                updateUI(null);
                // Optionally transfer playback automatically
                // transferPlayback(device_id);
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
                deviceId = null;
                displayError("Player has gone offline.");
                updateUI(null);
            });

            player.connect().then(success => {
                if (success) {
                    console.log('Web Playback SDK successfully connected!');
                    trackInfoDiv.textContent = "Connected. Waiting for player ready...";
                } else {
                     console.error('Web Playback SDK failed to connect.');
                     displayError("Failed to connect the SDK. Check browser console.");
                     showLogin();
                }
            }).catch(error => {
                 console.error('Error connecting player:', error);
                 displayError(`Connection error: ${error.message || error}`);
                 showLogin();
            });
        }

         /**
          * Transfers playback to this web player. (Unchanged)
          * @param {string} targetDeviceId - The device ID of this web player.
          */
        async function transferPlayback(targetDeviceId) {
            // (Function content remains the same as before)
            if (!currentAccessToken || !targetDeviceId) {
                console.warn("Cannot transfer playback: Missing token or device ID.");
                return;
            }
            try {
                await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${currentAccessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        device_ids: [targetDeviceId],
                        play: false
                    }),
                });
                console.log(`Playback transfer requested to device ${targetDeviceId}`);
            } catch (error) {
                displayError(`Failed to transfer playback: ${error.message}`);
                console.error("Error transferring playback:", error);
            }
        }


        // --- Event Listeners ---
        saveClientIdButton.addEventListener('click', saveClientId);
        clearClientIdButton.addEventListener('click', clearClientId);

        // Optional: Save when pressing Enter in the input field
        clientIdInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                saveClientId();
            }
        });

        loginButton.addEventListener('click', (e) => {
            e.preventDefault();
            redirectToSpotifyLogin();
        });

        playPauseButton.addEventListener('click', () => {
            if (!player) return;
            player.togglePlay().catch(err => displayError(`Toggle play failed: ${err.message}`));
        });

        prevButton.addEventListener('click', () => {
            if (!player) return;
            player.previousTrack().catch(err => displayError(`Previous track failed: ${err.message}`));
        });

        nextButton.addEventListener('click', () => {
            if (!player) return;
            player.nextTrack().catch(err => displayError(`Next track failed: ${err.message}`));
        });

        // --- Initialization ---
        // Load Client ID and check for access token on page load
        window.addEventListener('load', handleAuthentication);

    </script>
</body>
</html>
