<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Spotify Player</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling using monospace font and dark theme */
        body {
            font-family: monospace;
            background-color: #121212; /* Dark background */
            color: #b3b3b3; /* Light grey text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        /* Styling for buttons */
        button {
            background: none;
            border: 1px solid #b3b3b3;
            color: #b3b3b3;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            text-decoration: none;
            display: inline-block;
            border-radius: 4px; /* Slightly rounded corners */
            vertical-align: middle; /* Align buttons and inputs */
            transition: all 0.2s ease; /* Smooth hover effect */
        }
        button:hover {
            border-color: #ffffff;
            color: #ffffff;
            background-color: rgba(255, 255, 255, 0.1); /* Subtle background on hover */
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        /* Styling for text input fields */
        input[type="text"] {
            background-color: #282828;
            border: 1px solid #535353;
            color: #ffffff;
            padding: 5px 8px;
            font-family: monospace;
            border-radius: 4px;
            margin: 5px;
            min-width: 250px; /* Give input some width */
            vertical-align: middle; /* Align with buttons */
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #b3b3b3;
        }
        /* Styling for the track info display */
        .track-info {
            margin-top: 20px;
            min-height: 40px; /* Reserve space */
            font-size: 1.1em;
        }
        /* Styling for error messages */
        .error-message {
            color: #f56565; /* Red color for errors */
            margin-top: 15px;
            min-height: 1.2em; /* Reserve space for errors */
        }
        /* Styling for informational messages */
        .info-message {
            color: #a0aec0; /* Lighter grey for info */
            font-size: 0.9em;
            margin-top: 5px;
        }
        /* Styling for sections like Client ID input */
        .input-section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px dashed #535353;
            border-radius: 4px;
        }
        /* Styling for the access token footer */
        .token-footer {
            margin-top: 25px;
            font-size: 0.8em;
            color: #535353; /* Faded color */
            word-break: break-all; /* Allow long token to wrap */
            padding: 5px;
            border-top: 1px solid #282828; /* Subtle separator */
        }
        /* Styling for refresh button (kept in case needed, but less critical now) */
        #refresh-button {
            font-size: 0.8em;
            padding: 3px 6px;
            margin-left: 10px;
            display: none; /* Hide by default, less needed with Playback SDK events */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-xl mb-4">[ Cade's Minimal Player ]</h1> 
        
        
        <div id="login-section">
            <div class="input-section client-id-section">
                <label for="client-id-input" class="block mb-1">1. Spotify Client ID:</label>
                <input type="text" id="client-id-input" placeholder="Enter your Spotify Client ID">
                <button id="save-client-id-button" title="Save Client ID to browser storage">[ Save ID ]</button>
                <button id="clear-client-id-button" title="Clear saved Client ID">[ Clear ]</button>
                <p id="client-id-status" class="info-message"></p>
            </div>

            <div class="input-section access-token-section">
                <label for="access-token-input" class="block mb-1">2. Access Token (Optional):</label>
                <input type="text" id="access-token-input" placeholder="Enter existing Access Token (optional)">
                 <p class="info-message">If provided, login uses this token & skips Spotify redirect.</p>
            </div>

            <p class="mb-2" id="login-prompt">Enter Client ID (and optionally Access Token), then Login.</p>
            <button id="login-button">[ Login / Connect Player ]</button>
            <p class="text-xs mt-2">(Requires Spotify Premium for playback)</p> 
        </div>

        
        <div id="player-section" style="display: none;">
            <div class="controls">
                <button id="prev-button" title="Previous Track" disabled>[ Prev ]</button>
                <button id="play-pause-button" title="Play/Pause" disabled>[ Play ]</button>
                <button id="next-button" title="Next Track" disabled>[ Next ]</button>
                <button id="refresh-button" title="Refresh playback state">[ Refresh API State ]</button> 
            </div>
            <div id="track-info" class="track-info">
                Initializing Player...
            </div>
            <div id="device-info" class="text-sm mt-2"> 
                Player Device: <span id="device-name">N/A</span> (<span id="device-id">N/A</span>)
            </div>
            <div id="token-footer" class="token-footer">
                Access Token: N/A
            </div>
        </div>

        
        <div id="error-message" class="error-message"></div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js/src/spotify-web-api.js"></script> 
    
    <script>
        
                !function e(t, n, r) {
                    function s(a, i) {
                        if (!n[a]) {
                            if (!t[a]) {
                                var u = "function" == typeof require && require;
                                if (!i && u)
                                    return u(a, !0);
                                if (o)
                                    return o(a, !0);
                                var c = new Error("Cannot find module '" + a + "'");
                                throw c.code = "MODULE_NOT_FOUND",
                                c
                            }
                            var f = n[a] = {
                                exports: {}
                            };
                            t[a][0].call(f.exports, (function(e) {
                                return s(t[a][1][e] || e)
                            }
                            ), f, f.exports, e, t, n, r)
                        }
                        return n[a].exports
                    }
                    for (var o = "function" == typeof require && require, a = 0; a < r.length; a++)
                        s(r[a]);
                    return s
                }({
                    1: [function(e, t, n) {
                        "use strict";
                        Object.defineProperty(n, "__esModule", {
                            value: !0
                        }),
                        n.createPromiseResolver = function() {
                            var e, t;
                            return {
                                promise: new Promise((function(n, r) {
                                    e = n,
                                    t = r
                                }
                                )),
                                resolve: e,
                                reject: t
                            }
                        }
                    }
                    , {}],
                    2: [function(e, t, n) {
                        (function(e) {
                            (function() {
                        var n, r, s, o, a, i, u, c, f, l, _, p, E, d, y, h, g, v, R, m, A, T, M, O;
                        !function(n) {
                            var r = "object" == typeof e ? e : "object" == typeof self ? self : "object" == typeof this ? this : {};
                            function s(e, t) {
                                return e !== r && ("function" == typeof Object.create ? Object.defineProperty(e, "__esModule", {
                                    value: !0
                                }) : e.__esModule = !0),
                                function(n, r) {
                                    return e[n] = t ? t(n, r) : r
                                }
                            }
                            "function" == typeof define && define.amd ? define("tslib", ["exports"], (function(e) {
                                n(s(r, s(e)))
                            }
                            )) : "object" == typeof t && "object" == typeof t.exports ? n(s(r, s(t.exports))) : n(s(r))
                        }((function(e) {
                            var t = Object.setPrototypeOf || {
                                __proto__: []
                            }instanceof Array && function(e, t) {
                                e.__proto__ = t
                            }
                            || function(e, t) {
                                for (var n in t)
                                    Object.prototype.hasOwnProperty.call(t, n) && (e[n] = t[n])
                            }
                            ;
                            n = function(e, n) {
                                if ("function" != typeof n && null !== n)
                                    throw new TypeError("Class extends value " + String(n) + " is not a constructor or null");
                                function r() {
                                    this.constructor = e
                                }
                                t(e, n),
                                e.prototype = null === n ? Object.create(n) : (r.prototype = n.prototype,
                                new r)
                            }
                            ,
                            r = Object.assign || function(e) {
                                for (var t, n = 1, r = arguments.length; n < r; n++)
                                    for (var s in t = arguments[n])
                                        Object.prototype.hasOwnProperty.call(t, s) && (e[s] = t[s]);
                                return e
                            }
                            ,
                            s = function(e, t) {
                                var n = {};
                                for (var r in e)
                                    Object.prototype.hasOwnProperty.call(e, r) && t.indexOf(r) < 0 && (n[r] = e[r]);
                                if (null != e && "function" == typeof Object.getOwnPropertySymbols) {
                                    var s = 0;
                                    for (r = Object.getOwnPropertySymbols(e); s < r.length; s++)
                                        t.indexOf(r[s]) < 0 && Object.prototype.propertyIsEnumerable.call(e, r[s]) && (n[r[s]] = e[r[s]])
                                }
                                return n
                            }
                            ,
                            o = function(e, t, n, r) {
                                var s, o = arguments.length, a = o < 3 ? t : null === r ? r = Object.getOwnPropertyDescriptor(t, n) : r;
                                if ("object" == typeof Reflect && "function" == typeof Reflect.decorate)
                                    a = Reflect.decorate(e, t, n, r);
                                else
                                    for (var i = e.length - 1; i >= 0; i--)
                                        (s = e[i]) && (a = (o < 3 ? s(a) : o > 3 ? s(t, n, a) : s(t, n)) || a);
                                return o > 3 && a && Object.defineProperty(t, n, a),
                                a
                            }
                            ,
                            a = function(e, t) {
                                return function(n, r) {
                                    t(n, r, e)
                                }
                            }
                            ,
                            i = function(e, t) {
                                if ("object" == typeof Reflect && "function" == typeof Reflect.metadata)
                                    return Reflect.metadata(e, t)
                            }
                            ,
                            u = function(e, t, n, r) {
                                return new (n || (n = Promise))((function(s, o) {
                                    function a(e) {
                                        try {
                                            u(r.next(e))
                                        } catch (e) {
                                            o(e)
                                        }
                                    }
                                    function i(e) {
                                        try {
                                            u(r.throw(e))
                                        } catch (e) {
                                            o(e)
                                        }
                                    }
                                    function u(e) {
                                        var t;
                                        e.done ? s(e.value) : (t = e.value,
                                        t instanceof n ? t : new n((function(e) {
                                            e(t)
                                        }
                                        ))).then(a, i)
                                    }
                                    u((r = r.apply(e, t || [])).next())
                                }
                                ))
                            }
                            ,
                            c = function(e, t) {
                                var n, r, s, o, a = {
                                    label: 0,
                                    sent: function() {
                                        if (1 & s[0])
                                            throw s[1];
                                        return s[1]
                                    },
                                    trys: [],
                                    ops: []
                                };
                                return o = {
                                    next: i(0),
                                    throw: i(1),
                                    return: i(2)
                                },
                                "function" == typeof Symbol && (o[Symbol.iterator] = function() {
                                    return this
                                }
                                ),
                                o;
                                function i(o) {
                                    return function(i) {
                                        return function(o) {
                                            if (n)
                                                throw new TypeError("Generator is already executing.");
                                            for (; a; )
                                                try {
                                                    if (n = 1,
                                                    r && (s = 2 & o[0] ? r.return : o[0] ? r.throw || ((s = r.return) && s.call(r),
                                                    0) : r.next) && !(s = s.call(r, o[1])).done)
                                                        return s;
                                                    switch (r = 0,
                                                    s && (o = [2 & o[0], s.value]),
                                                    o[0]) {
                                                    case 0:
                                                    case 1:
                                                        s = o;
                                                        break;
                                                    case 4:
                                                        return a.label++,
                                                        {
                                                            value: o[1],
                                                            done: !1
                                                        };
                                                    case 5:
                                                        a.label++,
                                                        r = o[1],
                                                        o = [0];
                                                        continue;
                                                    case 7:
                                                        o = a.ops.pop(),
                                                        a.trys.pop();
                                                        continue;
                                                    default:
                                                        if (!(s = a.trys,
                                                        (s = s.length > 0 && s[s.length - 1]) || 6 !== o[0] && 2 !== o[0])) {
                                                            a = 0;
                                                            continue
                                                        }
                                                        if (3 === o[0] && (!s || o[1] > s[0] && o[1] < s[3])) {
                                                            a.label = o[1];
                                                            break
                                                        }
                                                        if (6 === o[0] && a.label < s[1]) {
                                                            a.label = s[1],
                                                            s = o;
                                                            break
                                                        }
                                                        if (s && a.label < s[2]) {
                                                            a.label = s[2],
                                                            a.ops.push(o);
                                                            break
                                                        }
                                                        s[2] && a.ops.pop(),
                                                        a.trys.pop();
                                                        continue
                                                    }
                                                    o = t.call(e, a)
                                                } catch (e) {
                                                    o = [6, e],
                                                    r = 0
                                                } finally {
                                                    n = s = 0
                                                }
                                            if (5 & o[0])
                                                throw o[1];
                                            return {
                                                value: o[0] ? o[1] : void 0,
                                                done: !0
                                            }
                                        }([o, i])
                                    }
                                }
                            }
                            ,
                            f = function(e, t) {
                                for (var n in e)
                                    "default" === n || Object.prototype.hasOwnProperty.call(t, n) || O(t, e, n)
                            }
                            ,
                            O = Object.create ? function(e, t, n, r) {
                                void 0 === r && (r = n),
                                Object.defineProperty(e, r, {
                                    enumerable: !0,
                                    get: function() {
                                        return t[n]
                                    }
                                })
                            }
                            : function(e, t, n, r) {
                                void 0 === r && (r = n),
                                e[r] = t[n]
                            }
                            ,
                            l = function(e) {
                                var t = "function" == typeof Symbol && Symbol.iterator
                                  , n = t && e[t]
                                  , r = 0;
                                if (n)
                                    return n.call(e);
                                if (e && "number" == typeof e.length)
                                    return {
                                        next: function() {
                                            return e && r >= e.length && (e = void 0),
                                            {
                                                value: e && e[r++],
                                                done: !e
                                            }
                                        }
                                    };
                                throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.")
                            }
                            ,
                            _ = function(e, t) {
                                var n = "function" == typeof Symbol && e[Symbol.iterator];
                                if (!n)
                                    return e;
                                var r, s, o = n.call(e), a = [];
                                try {
                                    for (; (void 0 === t || t-- > 0) && !(r = o.next()).done; )
                                        a.push(r.value)
                                } catch (e) {
                                    s = {
                                        error: e
                                    }
                                } finally {
                                    try {
                                        r && !r.done && (n = o.return) && n.call(o)
                                    } finally {
                                        if (s)
                                            throw s.error
                                    }
                                }
                                return a
                            }
                            ,
                            p = function() {
                                for (var e = [], t = 0; t < arguments.length; t++)
                                    e = e.concat(_(arguments[t]));
                                return e
                            }
                            ,
                            E = function() {
                                for (var e = 0, t = 0, n = arguments.length; t < n; t++)
                                    e += arguments[t].length;
                                var r = Array(e)
                                  , s = 0;
                                for (t = 0; t < n; t++)
                                    for (var o = arguments[t], a = 0, i = o.length; a < i; a++,
                                    s++)
                                        r[s] = o[a];
                                return r
                            }
                            ,
                            d = function(e, t, n) {
                                if (n || 2 === arguments.length)
                                    for (var r, s = 0, o = t.length; s < o; s++)
                                        !r && s in t || (r || (r = Array.prototype.slice.call(t, 0, s)),
                                        r[s] = t[s]);
                                return e.concat(r || t)
                            }
                            ,
                            y = function(e) {
                                return this instanceof y ? (this.v = e,
                                this) : new y(e)
                            }
                            ,
                            h = function(e, t, n) {
                                if (!Symbol.asyncIterator)
                                    throw new TypeError("Symbol.asyncIterator is not defined.");
                                var r, s = n.apply(e, t || []), o = [];
                                return r = {},
                                a("next"),
                                a("throw"),
                                a("return"),
                                r[Symbol.asyncIterator] = function() {
                                    return this
                                }
                                ,
                                r;
                                function a(e) {
                                    s[e] && (r[e] = function(t) {
                                        return new Promise((function(n, r) {
                                            o.push([e, t, n, r]) > 1 || i(e, t)
                                        }
                                        ))
                                    }
                                    )
                                }
                                function i(e, t) {
                                    try {
                                        (n = s[e](t)).value instanceof y ? Promise.resolve(n.value.v).then(u, c) : f(o[0][2], n)
                                    } catch (e) {
                                        f(o[0][3], e)
                                    }
                                    var n
                                }
                                function u(e) {
                                    i("next", e)
                                }
                                function c(e) {
                                    i("throw", e)
                                }
                                function f(e, t) {
                                    e(t),
                                    o.shift(),
                                    o.length && i(o[0][0], o[0][1])
                                }
                            }
                            ,
                            g = function(e) {
                                var t, n;
                                return t = {},
                                r("next"),
                                r("throw", (function(e) {
                                    throw e
                                }
                                )),
                                r("return"),
                                t[Symbol.iterator] = function() {
                                    return this
                                }
                                ,
                                t;
                                function r(r, s) {
                                    t[r] = e[r] ? function(t) {
                                        return (n = !n) ? {
                                            value: y(e[r](t)),
                                            done: "return" === r
                                        } : s ? s(t) : t
                                    }
                                    : s
                                }
                            }
                            ,
                            v = function(e) {
                                if (!Symbol.asyncIterator)
                                    throw new TypeError("Symbol.asyncIterator is not defined.");
                                var t, n = e[Symbol.asyncIterator];
                                return n ? n.call(e) : (e = l(e),
                                t = {},
                                r("next"),
                                r("throw"),
                                r("return"),
                                t[Symbol.asyncIterator] = function() {
                                    return this
                                }
                                ,
                                t);
                                function r(n) {
                                    t[n] = e[n] && function(t) {
                                        return new Promise((function(r, s) {
                                            (function(e, t, n, r) {
                                                Promise.resolve(r).then((function(t) {
                                                    e({
                                                        value: t,
                                                        done: n
                                                    })
                                                }
                                                ), t)
                                            }
                                            )(r, s, (t = e[n](t)).done, t.value)
                                        }
                                        ))
                                    }
                                }
                            }
                            ,
                            R = function(e, t) {
                                return Object.defineProperty ? Object.defineProperty(e, "raw", {
                                    value: t
                                }) : e.raw = t,
                                e
                            }
                            ;
                            var P = Object.create ? function(e, t) {
                                Object.defineProperty(e, "default", {
                                    enumerable: !0,
                                    value: t
                                })
                            }
                            : function(e, t) {
                                e.default = t
                            }
                            ;
                            m = function(e) {
                                if (e && e.__esModule)
                                    return e;
                                var t = {};
                                if (null != e)
                                    for (var n in e)
                                        "default" !== n && Object.prototype.hasOwnProperty.call(e, n) && O(t, e, n);
                                return P(t, e),
                                t
                            }
                            ,
                            A = function(e) {
                                return e && e.__esModule ? e : {
                                    default: e
                                }
                            }
                            ,
                            T = function(e, t, n, r) {
                                if ("a" === n && !r)
                                    throw new TypeError("Private accessor was defined without a getter");
                                if ("function" == typeof t ? e !== t || !r : !t.has(e))
                                    throw new TypeError("Cannot read private member from an object whose class did not declare it");
                                return "m" === n ? r : "a" === n ? r.call(e) : r ? r.value : t.get(e)
                            }
                            ,
                            M = function(e, t, n, r, s) {
                                if ("m" === r)
                                    throw new TypeError("Private method is not writable");
                                if ("a" === r && !s)
                                    throw new TypeError("Private accessor was defined without a setter");
                                if ("function" == typeof t ? e !== t || !s : !t.has(e))
                                    throw new TypeError("Cannot write private member to an object whose class did not declare it");
                                return "a" === r ? s.call(e, n) : s ? s.value = n : t.set(e, n),
                                n
                            }
                            ,
                            e("__extends", n),
                            e("__assign", r),
                            e("__rest", s),
                            e("__decorate", o),
                            e("__param", a),
                            e("__metadata", i),
                            e("__awaiter", u),
                            e("__generator", c),
                            e("__exportStar", f),
                            e("__createBinding", O),
                            e("__values", l),
                            e("__read", _),
                            e("__spread", p),
                            e("__spreadArrays", E),
                            e("__spreadArray", d),
                            e("__await", y),
                            e("__asyncGenerator", h),
                            e("__asyncDelegator", g),
                            e("__asyncValues", v),
                            e("__makeTemplateObject", R),
                            e("__importStar", m),
                            e("__importDefault", A),
                            e("__classPrivateFieldGet", T),
                            e("__classPrivateFieldSet", M)
                        }
                        ))
                    }
                    ).call(this)
                }
                ).call(this, "undefined" != typeof global ? global : "undefined" != typeof self ? self : "undefined" != typeof window ? window : {})
            }
            , {}],
            3: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.AnthemEvents = void 0,
                function(e) {
                    e.ACCOUNT_ERROR = "account_error",
                    e.AUTH_ERROR = "authentication_error",
                    e.AUTOPLAY_FAILED = "autoplay_failed",
                    e.PROGRESS = "progress",
                    e.PLAYBACK_ERROR = "playback_error",
                    e.PLAYER_INIT_ERROR = "initialization_error",
                    e.PLAYER_READY = "ready",
                    e.PLAYER_NOT_READY = "not_ready",
                    e.PLAYER_STATE_CHANGED = "player_state_changed"
                }(n.AnthemEvents || (n.AnthemEvents = {}))
            }
            , {}],
            4: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.Errors = void 0,
                function(e) {
                    e.INVALID_LISTENER = "INVALID_LISTENER",
                    e.INVALID_WEBPLAYBACK = "INVALID_WEBPLAYBACK",
                    e.NO_BODY = "NO_BODY",
                    e.NO_EVENT = "NO_EVENT",
                    e.INVALID_OAUTH = "INVALID_OAUTH",
                    e.MISSING_IFRAME = "MISSING_IFRAME",
                    e.AUTOPLAY_FAILED = "AUTOPLAY_FAILED"
                }(n.Errors || (n.Errors = {}))
            }
            , {}],
            5: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.Messages = void 0,
                function(e) {
                    e.SPOTIFY_MESSAGE = "SP_MESSAGE",
                    e.ACCOUNT_ERROR = "ACCOUNT_ERROR",
                    e.AUTH_ERROR = "AUTH_ERROR",
                    e.CONNECT = "CONNECT",
                    e.CONNECTED = "CONNECTED",
                    e.CURRENT_STATE = "CURRENT_STATE",
                    e.DISCONNECT = "DISCONNECT",
                    e.EVENT = "EVENT",
                    e.GET_CURRENT_STATE = "GET_CURRENT_STATE",
                    e.GET_TOKEN = "GET_TOKEN",
                    e.GET_VOLUME = "GET_VOLUME",
                    e.INIT = "INIT",
                    e.LOADED = "LOADED",
                    e.NEXT_TRACK = "NEXT_TRACK",
                    e.PAUSE = "PAUSE",
                    e.PLAYBACK_ERROR = "PLAYBACK_ERROR",
                    e.ACTIVATE_ELEMENT = "ACTIVATE_ELEMENT",
                    e.ACTIVATE_ELEMENT_ERROR = "ACTIVATE_ELEMENT_ERROR",
                    e.PLAYER_INIT_ERROR = "PLAYER_INIT_ERROR",
                    e.PLAYER_READY = "PLAYER_READY",
                    e.PLAYER_NOT_READY = "PLAYER_NOT_READY",
                    e.PLAYER_STATE_CHANGED = "PLAYER_STATE_CHANGED",
                    e.PREV_TRACK = "PREV_TRACK",
                    e.PROGRESS = "PROGRESS",
                    e.RESUME = "RESUME",
                    e.SEEK = "SEEK",
                    e.SET_NAME = "SET_NAME",
                    e.SET_VOLUME = "SET_VOLUME",
                    e.TOGGLE_PLAY = "TOGGLE_PLAY",
                    e.TOKEN = "TOKEN",
                    e.VOLUME = "VOLUME",
                    e.AUTOPLAY_FAILED = "AUTOPLAY_FAILED"
                }(n.Messages || (n.Messages = {}))
            }
            , {}],
            6: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.PlayerError = void 0;
                var r = e("tslib")
                  , s = function(e) {
                    function t(t, n) {
                        var r = e.call(this, n) || this;
                        return r.code = t,
                        r.message = n,
                        r.name = "AnthemError",
                        r
                    }
                    return r.__extends(t, e),
                    t
                }(Error);
                n.PlayerError = s
            }
            , {
                tslib: 2
            }],
            7: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                });
                var r = e("../enums/errors")
                  , s = e("../error/player_error")
                  , o = e("./player_api");
                function a() {
                    if (!document.body)
                        throw new s.PlayerError(r.Errors.NO_BODY,"Document doesn't have a body");
                    if (window.Spotify = {
                        Player: o.setupPlayerEnv(window)
                    },
                    window.onSpotifyWebPlaybackSDKReady)
                        return window.onSpotifyWebPlaybackSDKReady();
                    if (window.onSpotifyPlayerAPIReady)
                        return window.onSpotifyPlayerAPIReady();
                    throw new s.PlayerError(r.Errors.INVALID_WEBPLAYBACK,"onSpotifyWebPlaybackSDKReady is not defined")
                }
                "complete" === document.readyState ? a() : window.addEventListener("load", a)
            }
            , {
                "../enums/errors": 4,
                "../error/player_error": 6,
                "./player_api": 8
            }],
            8: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.setupPlayerEnv = void 0;
                var r = e("tslib")
                  , s = e("@js-sdk/common/lib/promise_resolver")
                  , o = e("../enums/messages")
                  , a = e("../enums/anthemEvents")
                  , i = e("../enums/errors")
                  , u = e("../error/player_error")
                  , c = e("../shared/message_dispatcher")
                  , f = e("../shared/messages_factory");
                n.setupPlayerEnv = function(e, t) {
                    var n = "https://sdk.scdn.co/embedded/index.html"
                      , l = s.createPromiseResolver()
                      , _ = c.MessageDispatcher.create()
                      , p = t || function(t) {
                        var n = e.document.createElement("iframe");
                        return n.src = t,
                        n.setAttribute("alt", "Audio Playback Container"),
                        n.setAttribute("tabIndex", "-1"),
                        n.style.setProperty("position", "absolute", "important"),
                        n.style.setProperty("left", "-1px", "important"),
                        n.style.setProperty("width", "0", "important"),
                        n.style.setProperty("height", "0", "important"),
                        n.style.setProperty("border", "none", "important"),
                        n.style.setProperty("outline", "none", "important"),
                        n.allow = "encrypted-media; autoplay",
                        e.document.body.appendChild(n),
                        n.contentWindow
                    }
                    ;
                    _.listen(e, (function(t) {
                        t === o.Messages.LOADED && (_.stopListening(e),
                        l.resolve())
                    }
                    ));
                    var E = p(n);
                    return function() {
                        function t(t) {
                            var n, r, s, i, u = this;
                            this._options = {
                                name: t.name || (null === (s = null == e ? void 0 : e.location) || void 0 === s ? void 0 : s.hostname) || "",
                                getOAuthToken: t.getOAuthToken || t.getOauthToken,
                                volume: null !== (i = t.volume) && void 0 !== i ? i : 1,
                                enableMediaSession: t.enableMediaSession
                            },
                            this._handleMessages = this._handleMessages.bind(this),
                            this._eventListeners = ((n = {})[a.AnthemEvents.ACCOUNT_ERROR] = [],
                            n[a.AnthemEvents.AUTH_ERROR] = [],
                            n[a.AnthemEvents.AUTOPLAY_FAILED] = [],
                            n[a.AnthemEvents.PLAYBACK_ERROR] = [],
                            n[a.AnthemEvents.PLAYER_INIT_ERROR] = [],
                            n[a.AnthemEvents.PLAYER_READY] = [],
                            n[a.AnthemEvents.PLAYER_NOT_READY] = [],
                            n[a.AnthemEvents.PLAYER_STATE_CHANGED] = [],
                            n[a.AnthemEvents.PROGRESS] = [],
                            n),
                            this._connectionRequests = {},
                            this._getCurrentStateRequests = {},
                            this._getVolumeRequests = {},
                            this._messageHandlers = ((r = {})[o.Messages.GET_TOKEN] = this._onGetToken.bind(this),
                            r[o.Messages.EVENT] = this._onEvent.bind(this),
                            r[o.Messages.CONNECTED] = this._onConnected.bind(this),
                            r[o.Messages.CURRENT_STATE] = this._onCurrentState.bind(this),
                            r[o.Messages.VOLUME] = this._onVolume.bind(this),
                            r),
                            this.isLoaded = l.promise.then((function() {
                                _.listen(e, u._handleMessages),
                                u._sendMessage(f.messages.init(u._options))
                            }
                            ))
                        }
                        return t.prototype._getListeners = function(e) {
                            return r.__spreadArray([], this._eventListeners[e])
                        }
                        ,
                        t.prototype._onEvent = function(e) {
                            var t = e.name;
                            this._getListeners(a.AnthemEvents[t]).forEach((function(t) {
                                t(e.eventData)
                            }
                            ))
                        }
                        ,
                        t.prototype._onGetToken = function(e, t) {
                            var n = this
                              , r = this._options.getOAuthToken;
                            if ("function" == typeof r)
                                new Promise(r).then((function(e) {
                                    n._sendMessage(f.messages.token(e, t))
                                }
                                ));
                            else {
                                if (!this._getListeners(a.AnthemEvents.PLAYER_INIT_ERROR).length)
                                    throw new u.PlayerError(i.Errors.INVALID_OAUTH,"getOAuthToken is not a function");
                                this._onEvent({
                                    name: o.Messages.PLAYER_INIT_ERROR,
                                    eventData: {
                                        message: i.Errors.INVALID_OAUTH
                                    }
                                })
                            }
                        }
                        ,
                        t.prototype._onConnected = function(e) {
                            var t;
                            e.ref in this._connectionRequests && (null === (t = this._connectionRequests[e.ref]) || void 0 === t || t.resolve(e.connected),
                            delete this._connectionRequests[e.ref])
                        }
                        ,
                        t.prototype._onCurrentState = function(e) {
                            var t;
                            e.ref in this._getCurrentStateRequests && (null === (t = this._getCurrentStateRequests[e.ref]) || void 0 === t || t.resolve(e.state),
                            delete this._getCurrentStateRequests[e.ref])
                        }
                        ,
                        t.prototype._onVolume = function(e) {
                            var t;
                            e.ref in this._getVolumeRequests && (null === (t = this._getVolumeRequests[e.ref]) || void 0 === t || t.resolve(e.volume),
                            delete this._getVolumeRequests[e.ref])
                        }
                        ,
                        t.prototype._handleMessages = function(e, t, n) {
                            var r, s;
                            null === (s = (r = this._messageHandlers)[e]) || void 0 === s || s.call(r, t, n)
                        }
                        ,
                        t.prototype._sendMessage = function(e) {
                            return _.send(E, e, n)
                        }
                        ,
                        t.prototype._sendMessageWhenLoaded = function(e) {
                            var t = this;
                            return this.isLoaded.then((function() {
                                return t._sendMessage(e)
                            }
                            ))
                        }
                        ,
                        t.prototype.connect = function() {
                            var e = this;
                            return this.isLoaded.then((function() {
                                var t, n = e._sendMessage(f.messages.connect());
                                return e._connectionRequests[n] = s.createPromiseResolver(),
                                null === (t = e._connectionRequests[n]) || void 0 === t ? void 0 : t.promise
                            }
                            ))
                        }
                        ,
                        t.prototype.on = function(e, t) {
                            return -1 === this._eventListeners[e].indexOf(t) && (this._eventListeners[e].push(t),
                            !0)
                        }
                        ,
                        t.prototype.addListener = function(e, t) {
                            return this.on(e, t)
                        }
                        ,
                        t.prototype.removeListener = function(e, t) {
                            var n = this._eventListeners[e];
                            return 1 === arguments.length ? (this._eventListeners[e] = [],
                            !0) : !(!n || !n.length) && (this._eventListeners[e] = n.filter((function(e) {
                                return e !== t
                            }
                            )),
                            !0)
                        }
                        ,
                        t.prototype.getCurrentState = function() {
                            var e = this;
                            return this.isLoaded.then((function() {
                                var t, n = e._sendMessage(f.messages.getCurrentState());
                                return e._getCurrentStateRequests[n] = s.createPromiseResolver(),
                                null === (t = e._getCurrentStateRequests[n]) || void 0 === t ? void 0 : t.promise
                            }
                            ))
                        }
                        ,
                        t.prototype.getVolume = function() {
                            var e = this;
                            return this.isLoaded.then((function() {
                                var t, n = e._sendMessage(f.messages.getVolume());
                                return e._getVolumeRequests[n] = s.createPromiseResolver(),
                                null === (t = e._getVolumeRequests[n]) || void 0 === t ? void 0 : t.promise
                            }
                            ))
                        }
                        ,
                        t.prototype.setName = function(e) {
                            return this._sendMessageWhenLoaded(f.messages.setName(e))
                        }
                        ,
                        t.prototype.setVolume = function(e) {
                            return this._sendMessageWhenLoaded(f.messages.setVolume(e))
                        }
                        ,
                        t.prototype.activateElement = function() {
                            return this._sendMessageWhenLoaded(f.messages.activateElement())
                        }
                        ,
                        t.prototype.pause = function() {
                            return this._sendMessageWhenLoaded(f.messages.pause())
                        }
                        ,
                        t.prototype.resume = function() {
                            return this._sendMessageWhenLoaded(f.messages.resume())
                        }
                        ,
                        t.prototype.togglePlay = function() {
                            return this._sendMessageWhenLoaded(f.messages.togglePlay())
                        }
                        ,
                        t.prototype.seek = function(e) {
                            return this._sendMessageWhenLoaded(f.messages.seek(e))
                        }
                        ,
                        t.prototype.previousTrack = function(e) {
                            return this._sendMessageWhenLoaded(f.messages.previousTrack(e))
                        }
                        ,
                        t.prototype.nextTrack = function(e) {
                            return this._sendMessageWhenLoaded(f.messages.nextTrack(e))
                        }
                        ,
                        t.prototype.disconnect = function() {
                            return this._sendMessageWhenLoaded(f.messages.disconnect())
                        }
                        ,
                        t
                    }()
                }
            }
            , {
                "../enums/anthemEvents": 3,
                "../enums/errors": 4,
                "../enums/messages": 5,
                "../error/player_error": 6,
                "../shared/message_dispatcher": 9,
                "../shared/messages_factory": 10,
                "@js-sdk/common/lib/promise_resolver": 1,
                tslib: 2
            }],
            9: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.MessageDispatcher = void 0;
                var r = e("../enums/messages")
                  , s = function() {
                    function e() {
                        this._seq = 0,
                        this._onMessageCallback = function() {}
                        ,
                        this._receiveMessage = this._receiveMessage.bind(this)
                    }
                    return e.create = function() {
                        return new e
                    }
                    ,
                    e.prototype._addMessageId = function(e) {
                        return e.seq = this._seq++,
                        e
                    }
                    ,
                    e.prototype._receiveMessage = function(e) {
                        if (e.data) {
                            var t = e.data
                              , n = t.type
                              , s = t.body
                              , o = t.seq;
                            n === r.Messages.SPOTIFY_MESSAGE && (null == s ? void 0 : s.topic) && this._onMessageCallback(s.topic, s.data, o)
                        }
                    }
                    ,
                    e.prototype.listen = function(e, t) {
                        this._onMessageCallback = t,
                        e.addEventListener("message", this._receiveMessage)
                    }
                    ,
                    e.prototype.stopListening = function(e) {
                        e.removeEventListener("message", this._receiveMessage)
                    }
                    ,
                    e.prototype.send = function(e, t, n) {
                        void 0 === n && (n = "*");
                        var r = this._addMessageId(t);
                        return e.postMessage(r, n),
                        r.seq
                    }
                    ,
                    e
                }();
                n.MessageDispatcher = s
            }
            , {
                "../enums/messages": 5
            }],
            10: [function(e, t, n) {
                "use strict";
                Object.defineProperty(n, "__esModule", {
                    value: !0
                }),
                n.messages = void 0;
                var r = e("../enums/messages")
                  , s = function() {
                    function e() {}
                    return e.create = function() {
                        return new e
                    }
                    ,
                    e.prototype._createEventMessage = function(e, t) {
                        return this._createMessage(r.Messages.EVENT, {
                            name: e,
                            eventData: t
                        })
                    }
                    ,
                    e.prototype._createMessage = function(e, t) {
                        return {
                            type: r.Messages.SPOTIFY_MESSAGE,
                            body: {
                                topic: e,
                                data: void 0 !== t ? JSON.parse(JSON.stringify(t)) : void 0
                            }
                        }
                    }
                    ,
                    e.prototype.accountError = function(e) {
                        return this._createEventMessage(r.Messages.ACCOUNT_ERROR, {
                            message: e
                        })
                    }
                    ,
                    e.prototype.authError = function(e) {
                        return this._createEventMessage(r.Messages.AUTH_ERROR, e)
                    }
                    ,
                    e.prototype.autoplayFailed = function(e) {
                        return this._createEventMessage(r.Messages.AUTOPLAY_FAILED, e)
                    }
                    ,
                    e.prototype.playbackError = function(e) {
                        return this._createEventMessage(r.Messages.PLAYBACK_ERROR, e)
                    }
                    ,
                    e.prototype.playerReady = function(e) {
                        return this._createEventMessage(r.Messages.PLAYER_READY, e)
                    }
                    ,
                    e.prototype.playerNotReady = function(e) {
                        return this._createEventMessage(r.Messages.PLAYER_NOT_READY, e)
                    }
                    ,
                    e.prototype.connect = function() {
                        return this._createMessage(r.Messages.CONNECT)
                    }
                    ,
                    e.prototype.connected = function(e, t) {
                        return this._createMessage(r.Messages.CONNECTED, {
                            connected: e,
                            ref: t
                        })
                    }
                    ,
                    e.prototype.disconnect = function() {
                        return this._createMessage(r.Messages.DISCONNECT)
                    }
                    ,
                    e.prototype.init = function(e) {
                        return this._createMessage(r.Messages.INIT, e)
                    }
                    ,
                    e.prototype.playerInitError = function(e) {
                        return this._createEventMessage(r.Messages.PLAYER_INIT_ERROR, e)
                    }
                    ,
                    e.prototype.getToken = function() {
                        return this._createMessage(r.Messages.GET_TOKEN)
                    }
                    ,
                    e.prototype.token = function(e, t) {
                        return this._createMessage(r.Messages.TOKEN, {
                            token: e,
                            ref: t
                        })
                    }
                    ,
                    e.prototype.activateElement = function() {
                        return this._createMessage(r.Messages.ACTIVATE_ELEMENT)
                    }
                    ,
                    e.prototype.activateElementError = function(e) {
                        return this._createEventMessage(r.Messages.ACTIVATE_ELEMENT_ERROR, e)
                    }
                    ,
                    e.prototype.pause = function() {
                        return this._createMessage(r.Messages.PAUSE)
                    }
                    ,
                    e.prototype.resume = function() {
                        return this._createMessage(r.Messages.RESUME)
                    }
                    ,
                    e.prototype.togglePlay = function() {
                        return this._createMessage(r.Messages.TOGGLE_PLAY)
                    }
                    ,
                    e.prototype.seek = function(e) {
                        return this._createMessage(r.Messages.SEEK, e)
                    }
                    ,
                    e.prototype.nextTrack = function(e) {
                        return this._createMessage(r.Messages.NEXT_TRACK, e)
                    }
                    ,
                    e.prototype.previousTrack = function(e) {
                        return this._createMessage(r.Messages.PREV_TRACK, e)
                    }
                    ,
                    e.prototype.getCurrentState = function() {
                        return this._createMessage(r.Messages.GET_CURRENT_STATE)
                    }
                    ,
                    e.prototype.currentState = function(e, t) {
                        return this._createMessage(r.Messages.CURRENT_STATE, {
                            state: e,
                            ref: t
                        })
                    }
                    ,
                    e.prototype.playerStateChanged = function(e) {
                        return this._createEventMessage(r.Messages.PLAYER_STATE_CHANGED, e)
                    }
                    ,
                    e.prototype.progress = function(e) {
                        return this._createEventMessage(r.Messages.PROGRESS, e)
                    }
                    ,
                    e.prototype.getVolume = function() {
                        return this._createMessage(r.Messages.GET_VOLUME)
                    }
                    ,
                    e.prototype.volume = function(e, t) {
                        return this._createMessage(r.Messages.VOLUME, {
                            volume: e,
                            ref: t
                        })
                    }
                    ,
                    e.prototype.setVolume = function(e) {
                        return this._createMessage(r.Messages.SET_VOLUME, e)
                    }
                    ,
                    e.prototype.setName = function(e) {
                        return this._createMessage(r.Messages.SET_NAME, e)
                    }
                    ,
                    e.prototype.embeddedLoaded = function() {
                        return this._createMessage(r.Messages.LOADED)
                    }
                    ,
                    e
                }();
                n.messages = s.create()
            }
            , {
                "../enums/messages": 5
            }]
        }, {}, [7]);


    </script> 
    <script>
        // --- Configuration ---
        let clientId = null;
        const CLIENT_ID_STORAGE_KEY = 'spotifyMinimalPlayerClientId';
        const redirectUri = 'https://cadezawacki.github.io/sptfy.html'; // MUST match Spotify Dashboard
        const spotifyAuthorizeUrl = 'https://accounts.spotify.com/authorize'; 

        // Scopes needed for playback and control
        const scopes = [
            'streaming', // Needed for Web Playback SDK
            'user-read-email',
            'user-read-private',
            'user-read-playback-state',    // Read playback state (useful for API fallback/initial state)
            'user-modify-playback-state'   // Control playback (both SDK and API)
        ].join(' ');

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const playerSection = document.getElementById('player-section');
        const loginButton = document.getElementById('login-button');
        const prevButton = document.getElementById('prev-button');
        const playPauseButton = document.getElementById('play-pause-button');
        const nextButton = document.getElementById('next-button');
        const refreshButton = document.getElementById('refresh-button');
        const trackInfoDiv = document.getElementById('track-info');
        const deviceInfoDiv = document.getElementById('device-info');
        const deviceNameSpan = document.getElementById('device-name');
        const deviceIdSpan = document.getElementById('device-id'); // Using this for Player SDK Device ID
        const errorMessageDiv = document.getElementById('error-message');
        const clientIdInput = document.getElementById('client-id-input');
        const saveClientIdButton = document.getElementById('save-client-id-button');
        const clearClientIdButton = document.getElementById('clear-client-id-button');
        const clientIdStatus = document.getElementById('client-id-status');
        const loginPrompt = document.getElementById('login-prompt');
        const accessTokenInput = document.getElementById('access-token-input');
        const tokenFooterDiv = document.getElementById('token-footer');

        // --- Global Variables ---
        let spotifyApi = null; // spotify-web-api-js instance
        let player = null; // Spotify.Player instance (Playback SDK)
        let currentAccessToken = null;
        let localPlayerDeviceId = null; // Device ID for the browser player
        let isPlayerReady = false; // Flag for Playback SDK player readiness
        let isSdkReady = false; // Flag if the Playback SDK script itself has loaded
        let pendingInitializationToken = null; // Token waiting for SDK script to load

        // --- Functions ---

        function displayError(message, isWarning = false) {
            console.error(isWarning ? "Warning:" : "Error:", message);
            errorMessageDiv.textContent = `${isWarning ? 'Warning' : 'Error'}: ${message}`;
            errorMessageDiv.style.color = isWarning ? '#ecc94b' : '#f56565';
        }

        function clearError() {
            errorMessageDiv.textContent = '';
        }

        function updateClientIdStatus(message, isError = false) {
            clientIdStatus.textContent = message;
            clientIdStatus.style.color = isError ? '#f56565' : '#a0aec0';
        }

        function updateTokenFooter(token) {
            if (token) {
                tokenFooterDiv.textContent = `Access Token: ${token}`;
            } else {
                tokenFooterDiv.textContent = 'Access Token: N/A';
            }
        }

        function loadClientId() {
            try {
                const savedId = localStorage.getItem(CLIENT_ID_STORAGE_KEY);
                if (savedId) {
                    clientId = savedId;
                    clientIdInput.value = savedId;
                    updateClientIdStatus(`Loaded saved Client ID.`);
                    loginPrompt.textContent = "Client ID loaded. Enter optional token or Login.";
                    return true;
                } else {
                    updateClientIdStatus("No Client ID saved. Please enter and save.");
                    loginPrompt.textContent = "Please enter and save your Client ID, then login.";
                    return false;
                }
            } catch (e) {
                // Handle storage access errors
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to load Client ID.");
                updateClientIdStatus("Could not load Client ID from storage.", true);
                return false;
            }
        }

        function saveClientId() {
            const enteredId = clientIdInput.value.trim();
            if (!enteredId) {
                updateClientIdStatus("Client ID cannot be empty.", true);
                return false;
            }
            try {
                localStorage.setItem(CLIENT_ID_STORAGE_KEY, enteredId);
                clientId = enteredId;
                updateClientIdStatus("Client ID saved successfully.");
                loginPrompt.textContent = "Client ID saved. Enter optional token or Login.";
                clearError();
                return true;
            } catch (e) {
                // Handle storage access errors
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to save Client ID.");
                updateClientIdStatus("Failed to save Client ID to storage.", true);
                return false;
            }
        }

        function clearClientId() {
             try {
                localStorage.removeItem(CLIENT_ID_STORAGE_KEY);
                clientId = null;
                clientIdInput.value = '';
                updateClientIdStatus("Saved Client ID cleared.");
                loginPrompt.textContent = "Please enter and save your Client ID, then login.";
                clearError();
            } catch (e) {
                // Handle storage access errors
                console.error("Could not access localStorage:", e);
                displayError("Could not access browser storage to clear Client ID.");
                updateClientIdStatus("Failed to clear Client ID from storage.", true);
            }
        }

        /**
         * Updates the UI based primarily on the Web Playback SDK's state.
         * @param {object | null} state - The state object from Spotify.Player's player_state_changed event.
         */
        function updatePlayerUI(state) {
             if (!isPlayerReady || !state) {
                // Player not ready or state is null (disconnected?)
                trackInfoDiv.textContent = isPlayerReady ? "Player Ready. Select in Spotify or start playback." : "Player offline or initializing...";
                playPauseButton.textContent = '[ Play ]';
                playPauseButton.disabled = !isPlayerReady; // Only enable play if player is ready
                prevButton.disabled = true;
                nextButton.disabled = true;
                // Update device info even if state is null, if player is ready
                deviceNameSpan.textContent = player ? player._options.name : 'N/A';
                deviceIdSpan.textContent = localPlayerDeviceId || 'N/A';
                return;
            }

            // --- Player is ready and has state ---
            const track = state.track_window.current_track;
            const isPlaying = !state.paused;

            // Device Info (already set mostly)
            deviceNameSpan.textContent = player._options.name;
            deviceIdSpan.textContent = localPlayerDeviceId;

            // Track Info
            if (track) {
                const artists = track.artists.map(artist => artist.name).join(', ');
                trackInfoDiv.textContent = `${artists} - ${track.name}`;
            } else {
                trackInfoDiv.textContent = "No track loaded.";
            }

            // Controls State
            playPauseButton.textContent = isPlaying ? '[ Pause ]' : '[ Play ]';
            playPauseButton.disabled = false; // Enable controls now that we have state

            // Use SDK state for prev/next availability
            prevButton.disabled = !state.track_window.previous_tracks.length;
            nextButton.disabled = !state.track_window.next_tracks.length;
        }

        /**
         * Fetches playback state using the Web API (spotify-web-api-js).
         * Primarily useful for getting initial state or state of other devices.
         * NOTE: This state might differ from the local player's state if playback is elsewhere.
         */
        async function fetchApiPlaybackState() {
            if (!spotifyApi) {
                // displayError("API client not initialized.", true); // Maybe just log this
                console.warn("API client not initialized for fetchApiPlaybackState.");
                return null; // Return null if API not ready
            }
            console.log("Fetching playback state via API...");
            // clearError(); // Don't clear errors here, might overwrite player errors

            try {
                const state = await spotifyApi.getMyCurrentPlaybackState();
                console.log('API Playback state received:', state);
                return state; // Return the fetched state
            } catch (error) {
                console.error("Error fetching API playback state:", error);
                if (error.status === 401) {
                    displayError(`API Auth error: ${error.message || 'Token may be expired.'}. Please login again.`);
                    showLogin(); // Force re-login if token is bad for API
                } else {
                    // Don't necessarily show error in main div, could conflict with player status
                    console.error(`Failed to fetch API playback state: ${error.message || error}`);
                }
                return null; // Return null on error
            }
        }


        /**
         * Initializes the Spotify API client (spotify-web-api-js).
         * @param {string} token - The Spotify Access Token.
         */
        function initializeApiClient(token) {
             if (!token) {
                console.warn("Cannot initialize API client: Access token is missing.");
                return; // Don't show error, might be intentional if only player is needed initially
            }
             // Avoid re-initializing if already done with the same token
             if (spotifyApi && currentAccessToken === token) {
                 console.log("API client already initialized with this token.");
                 return;
             }

            currentAccessToken = token; // Update token even if re-initializing
            console.log("Initializing Spotify Web API client...");
            try {
                 spotifyApi = new SpotifyWebApi();
                 spotifyApi.setAccessToken(currentAccessToken);
                 console.log("API client initialized and token set.");
                 updateTokenFooter(currentAccessToken);
                 // Optionally fetch initial API state - but player state might be more relevant soon
                 // fetchApiPlaybackState().then(apiState => {
                 //    if (!isPlayerReady && apiState) { /* Maybe update UI if player isn't ready? */ }
                 // });
            } catch (e) {
                 console.error("Failed to instantiate SpotifyWebApi:", e);
                 displayError("Failed to load Spotify API library. Check console.");
                 // Don't necessarily force logout, player might still work
            }
        }

        /**
         * Initializes the Spotify Web Playback SDK Player.
         * This is called by window.onSpotifyWebPlaybackSDKReady or when token becomes available later.
         */
        function initializeSpotifyPlayer(token) {
            if (!token) {
                displayError("Cannot initialize player: Access token is missing.");
                showLogin(); // Player needs token
                return;
            }
             if (!isSdkReady) {
                 console.log("SDK script not ready yet, deferring player initialization.");
                 pendingInitializationToken = token; // Store token for later
                 return;
             }
             if (player) {
                console.log("Player already exists. Disconnecting previous instance.");
                isPlayerReady = false; // Mark as not ready while disconnecting
                player.disconnect();
                player = null; // Ensure old reference is cleared
            }

            console.log("Initializing Spotify Player instance...");
            trackInfoDiv.textContent = "Initializing Player...";
            updateTokenFooter(token); // Ensure footer shows the token being used

            // Create the player instance
            player = new Spotify.Player({
                name: 'Minimal Web Player', // Unique name
                getOAuthToken: cb => {
                    // Provide the token to the SDK when requested
                    console.log("Playback SDK requesting OAuth token.");
                    // You might add token refresh logic here in a real app
                    cb(currentAccessToken); // Provide the current token
                },
                volume: 0.5 // Default volume
            });

            // --- Player Event Listeners ---
            player.addListener('initialization_error', ({ message }) => {
                displayError(`Player Init failed: ${message}. Check Premium status, browser settings (DRM), and console.`);
                showLogin(); // Go back to login on critical init error
            });
            player.addListener('authentication_error', ({ message }) => {
                displayError(`Player Auth failed: ${message}. Token might be expired or invalid.`);
                currentAccessToken = null; // Token is bad for player
                showLogin(); // Force re-login
            });
            player.addListener('account_error', ({ message }) => {
                displayError(`Player Account error: ${message}. Spotify Premium required.`);
                // Don't force logout, user might fix it
            });
            player.addListener('playback_error', ({ message }) => {
                displayError(`Player Playback error: ${message}. Content might be restricted.`, true); // Show as warning
            });

            // State changes (track change, play/pause, etc.) - PRIMARY UI UPDATE SOURCE
            player.addListener('player_state_changed', (state) => {
                console.log('Player state changed:', state);
                if (!state) {
                    // State is null if player disconnects or has an issue
                    console.warn("Player state is null. Player may have disconnected.");
                    isPlayerReady = false; // Mark as not ready if state is null
                    // Optionally try to reconnect or show specific message
                }
                // Update UI based on the player's state
                updatePlayerUI(state);
            });

            // Player is ready to accept commands
            player.addListener('ready', ({ device_id }) => {
                console.log('Player ready with Device ID:', device_id);
                localPlayerDeviceId = device_id; // Store the local device ID
                isPlayerReady = true;
                trackInfoDiv.textContent = "Player Ready. Select this device ('Minimal Web Player') in Spotify app.";
                updatePlayerUI(null); // Update UI elements like device info span
                // You could automatically transfer playback here if desired:
                // transferPlaybackToLocalPlayer();
            });

            // Player is not ready (e.g., disconnected)
            player.addListener('not_ready', ({ device_id }) => {
                console.log('Player device ID has gone offline:', device_id);
                if (localPlayerDeviceId === device_id) { // Check if it's our player
                    localPlayerDeviceId = null;
                    isPlayerReady = false;
                    displayError("Player has gone offline.", true);
                    updatePlayerUI(null); // Update UI to reflect offline state
                }
            });

            // --- Connect the Player ---
            player.connect().then(success => {
                if (success) {
                    console.log('Web Playback SDK successfully connected!');
                    trackInfoDiv.textContent = "Connected. Waiting for player ready...";
                } else {
                     console.error('Web Playback SDK failed to connect.');
                     displayError("Failed to connect the SDK. Check console (e.g., active device limit, browser issues).");
                     // Don't force logout immediately, might be temporary
                }
            }).catch(error => {
                 console.error('Error connecting player:', error);
                 displayError(`Player Connection error: ${error.message || error}. Check console.`);
                 showLogin(); // Force logout on connection error
            });
        }

        /**
         * This function is called by the Spotify Playback SDK script once it's loaded.
         */
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log("Spotify Playback SDK Script Ready.");
            isSdkReady = true;
            // If initialization was pending because the SDK script wasn't loaded, start it now
            if (pendingInitializationToken) {
                console.log("SDK script is now ready, initializing player with pending token.");
                initializeSpotifyPlayer(pendingInitializationToken);
                pendingInitializationToken = null; // Clear the pending token
            }
        };


        /**
         * Handles the Spotify authentication redirect callback.
         */
        function handleAuthenticationCallback() {
            loadClientId(); // Ensure Client ID is loaded

            const params = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = params.get('access_token');
            const error = params.get('error');

            // Clear the hash from the URL
            if (window.location.hash) {
                 history.pushState("", document.title, window.location.pathname + window.location.search);
            }

            if (error) {
                displayError(`Authentication failed: ${error}`);
                showLogin();
                return;
            }

            if (accessToken) {
                console.log("Access Token received via redirect.");
                if (!clientId) {
                    displayError("Logged in via redirect, but Client ID is missing. Please save it again.");
                    showLogin();
                } else {
                    // Successfully authenticated via redirect
                    currentAccessToken = accessToken; // Store the token
                    showPlayer();
                    // Initialize BOTH the API client and the Playback SDK Player
                    initializeApiClient(currentAccessToken);
                    initializeSpotifyPlayer(currentAccessToken);
                }
            } else if (!currentAccessToken) {
                // No token in hash and no token provided directly earlier, show login
                showLogin();
            }
            // If currentAccessToken was set by direct input, this callback doesn't need to re-init
        }

        /**
         * Redirects the user to Spotify's login page for authorization.
         */
        function redirectToSpotifyLogin() {
            clearError();
            if (!clientId) {
                 displayError("Spotify Client ID is missing. Please enter and save it.");
                 updateClientIdStatus("Client ID is required before login.", true);
                 clientIdInput.focus();
                 return;
            }
            // Basic validation for redirect URI
            if (!redirectUri || redirectUri === 'YOUR_REDIRECT_URI' || !redirectUri.startsWith('http')) {
                displayError("Spotify Redirect URI is not configured correctly in the code.");
                console.error("Developer Error: Configure redirectUri variable properly.");
                return;
            }

            const authUrl = `${spotifyAuthorizeUrl}?${new URLSearchParams({
                response_type: 'token',
                client_id: clientId,
                scope: scopes, // Use updated scopes including 'streaming'
                redirect_uri: redirectUri,
            })}`;

            console.log(`Redirecting to Spotify login with Client ID: ${clientId}`);
            window.location.href = authUrl;
        }

       /**
         * Initiates the login process based on user input.
         * Initializes Player and API client if token is provided, otherwise redirects.
         */
        function initiateLogin() {
            clearError();
            const enteredClientId = clientIdInput.value.trim();
            const enteredAccessToken = accessTokenInput.value.trim();

            // 1. Validate Client ID
            if (!enteredClientId) {
                displayError("Spotify Client ID is required.");
                updateClientIdStatus("Please enter your Client ID.", true);
                clientIdInput.focus();
                return;
            }
            // Save Client ID if it's different or not loaded
            if (enteredClientId !== clientId) {
                if (!saveClientId()) { return; } // saveClientId updates global `clientId`
            }

            // 2. Check for manually entered Access Token
            if (enteredAccessToken) {
                console.log("Attempting login with provided Access Token (skipping redirect).");
                currentAccessToken = enteredAccessToken; // Store the token
                showPlayer();
                // Initialize BOTH the API client and the Playback SDK Player
                initializeApiClient(currentAccessToken);
                initializeSpotifyPlayer(currentAccessToken);
            } else {
                // 3. No token provided, proceed with standard redirect flow
                console.log("No Access Token provided, redirecting for Spotify authorization.");
                redirectToSpotifyLogin(); // This redirect is necessary to get a token
            }
        }

        /**
         * Shows the login section and hides the player section. Cleans up player state.
         */
        function showLogin() {
            loginSection.style.display = 'block';
            playerSection.style.display = 'none';
            updateClientIdStatus(clientId ? "Client ID loaded." : "No Client ID saved.");
            updateTokenFooter(null);
            accessTokenInput.value = ''; // Clear token input
            currentAccessToken = null;
            spotifyApi = null; // Clear API instance
            isPlayerReady = false;
            localPlayerDeviceId = null;
            pendingInitializationToken = null;
            if (player) {
                console.log("Disconnecting player instance.");
                player.disconnect(); // Disconnect SDK player
                player = null;
            }
            updatePlayerUI(null); // Reset UI elements
        }

        /**
         * Shows the player section and hides the login section.
         */
        function showPlayer() {
            loginSection.style.display = 'none';
            playerSection.style.display = 'block';
            updateClientIdStatus(""); // Clear client ID status message
            clearError(); // Clear any login errors
            trackInfoDiv.textContent = "Initializing..."; // Initial message
        }


        // --- Event Listeners ---
        saveClientIdButton.addEventListener('click', saveClientId);
        clearClientIdButton.addEventListener('click', clearClientId);
        clientIdInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveClientId(); });
        loginButton.addEventListener('click', (e) => { e.preventDefault(); initiateLogin(); });
        refreshButton.addEventListener('click', fetchApiPlaybackState); // Keep for debugging API state

        // --- Player Controls (use SDK Player methods) ---
        playPauseButton.addEventListener('click', () => {
            if (!player || !isPlayerReady) return;
            clearError(); // Clear minor errors on interaction
            console.log("Toggling play/pause via SDK player...");
            player.togglePlay().catch(err => {
                 console.error("Toggle play error:", err);
                 displayError(`Toggle play failed: ${err.message || err}`);
            });
            // UI will update via the 'player_state_changed' listener
        });

        prevButton.addEventListener('click', () => {
            if (!player || !isPlayerReady) return;
            clearError();
            console.log("Skipping to previous via SDK player...");
            player.previousTrack().catch(err => {
                console.error("Previous track error:", err);
                displayError(`Previous track failed: ${err.message || err}`);
            });
            // UI will update via the 'player_state_changed' listener
        });

        nextButton.addEventListener('click', () => {
            if (!player || !isPlayerReady) return;
            clearError();
            console.log("Skipping to next via SDK player...");
            player.nextTrack().catch(err => {
                console.error("Next track error:", err);
                displayError(`Next track failed: ${err.message || err}`);
            });
             // UI will update via the 'player_state_changed' listener
        });

        // --- Initialization ---
        window.addEventListener('load', () => {
            loadClientId();
            // Check for token in URL hash from redirect
            // handleAuthenticationCallback will initialize player/api if token found
            handleAuthenticationCallback();
        });

    </script>
</body>
</html>
