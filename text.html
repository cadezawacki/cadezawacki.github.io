<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Clipboard Transfer</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #homepage, #room { padding: 20px; }
    button { margin: 5px; padding: 8px 12px; }
    #roomHeader { margin-bottom: 10px; }
    #roomHeader span { margin-right: 15px; }
    textarea { width: 100%; height: 80vh; font-size: 16px; }
    input { padding: 4px; margin: 4px 0; }
  </style>
</head>
<body>
  <!-- Homepage with options -->
  <div id="homepage">
    <h1>Clipboard Transfer</h1>
    <button id="createRoomBtn">Create Room</button>
    <button id="joinRoomBtn">Join Room</button>
    <div id="formContainer" style="margin-top:20px;"></div>
  </div>

  <!-- Room interface -->
  <div id="room" style="display:none;">
    <div id="roomHeader">
      <span id="lastUpdate">Last update: N/A</span>
      <span id="timeRemaining">Time remaining: N/A</span>
      <button id="clearBtn">Clear</button>
      <button id="copyBtn">Copy</button>
    </div>
    <textarea id="textArea" placeholder="Type or paste text here..."></textarea>
  </div>

  <!-- Include PeerJS from a CDN -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    (function(){
      // Global state variables
      var mode = null; // "host" or "client"
      var peer = null;
      var connections = []; // for host: all client connections
      var conn = null;    // for client: connection to host
      var roomId = "";
      var roomPassword = "";
      var creationTime = 0; // timestamp (ms) when room was created
      var currentText = "";
      var lastUpdateTimestamp = 0;
      var isUpdating = false; // to avoid loops when updating textarea
      var updateTimeout = null; // for debouncing

      // DOM elements
      var homepage = document.getElementById("homepage");
      var formContainer = document.getElementById("formContainer");
      var roomDiv = document.getElementById("room");
      var textArea = document.getElementById("textArea");
      var lastUpdateElem = document.getElementById("lastUpdate");
      var timeRemainingElem = document.getElementById("timeRemaining");
      var clearBtn = document.getElementById("clearBtn");
      var copyBtn = document.getElementById("copyBtn");

      // Event listeners for homepage buttons
      document.getElementById("createRoomBtn").addEventListener("click", showCreateRoomForm);
      document.getElementById("joinRoomBtn").addEventListener("click", showJoinRoomForm);

      function showCreateRoomForm(){
        formContainer.innerHTML = `
          <h2>Create Room</h2>
          <label>Password (optional): <input type="text" id="createPassword"></label><br>
          <button id="createBtn">Create</button>
        `;
        document.getElementById("createBtn").addEventListener("click", function(){
          roomPassword = document.getElementById("createPassword").value;
          roomId = generateRoomId();
          mode = "host";
          creationTime = Date.now();
          initRoom();
          initHost();
        });
      }

      function showJoinRoomForm(){
        formContainer.innerHTML = `
          <h2>Join Room</h2>
          <label>Room ID: <input type="text" id="joinRoomId"></label><br>
          <label>Password (if any): <input type="text" id="joinPassword"></label><br>
          <button id="joinBtn">Join</button>
        `;
        document.getElementById("joinBtn").addEventListener("click", function(){
          roomId = document.getElementById("joinRoomId").value.trim();
          roomPassword = document.getElementById("joinPassword").value;
          if(!roomId){
            alert("Please enter a valid Room ID.");
            return;
          }
          mode = "client";
          initRoom();
          initClient();
        });
      }

      // Generate a random 6-character alphanumeric room id.
      function generateRoomId(){
        return Math.random().toString(36).substr(2, 6);
      }

      // Prepare the room UI and hide the homepage.
      function initRoom(){
        homepage.style.display = "none";
        formContainer.style.display = "none";
        roomDiv.style.display = "block";
        // Optionally, display the room id in the header.
        document.getElementById("roomHeader").innerHTML += `<span>Room ID: ${roomId}</span>`;
        updateLastUpdateDisplay(lastUpdateTimestamp);
      }

      // Initialize as host: create a Peer with roomId as the id.
      function initHost(){
        peer = new Peer(roomId, { debug: 2 });
        peer.on('open', function(id) {
          console.log("Host Peer opened with ID:", id);
        });
        peer.on('connection', function(connection){
          console.log("New connection from", connection.peer);
          connection.on('data', function(data){
            handleHostData(connection, data);
          });
          connections.push(connection);
        });
        peer.on('error', function(err){
          console.error(err);
          alert("Peer error: " + err);
        });
      }

      // Initialize as client: create a Peer and connect to the host (roomId).
      function initClient(){
        peer = new Peer({ debug: 2 });
        peer.on('open', function(id) {
          console.log("Client Peer opened with ID:", id);
          conn = peer.connect(roomId, { reliable: true });
          conn.on('open', function(){
            // Immediately send a join request including the (optional) password.
            conn.send({ type: "join", password: roomPassword });
          });
          conn.on('data', function(data){
            handleClientData(data);
          });
        });
        peer.on('error', function(err){
          console.error(err);
          alert("Peer error: " + err);
        });
      }

      // Host: Handle incoming data from a connection.
      function handleHostData(connection, data){
        if(data.type === "join"){
          // If a password was set at room creation, verify it.
          if(roomPassword && data.password !== roomPassword){
            connection.send({ type: "error", message: "Incorrect password" });
            connection.close();
            return;
          }
          // Send an init message with the current text state.
          connection.send({ type: "init", text: currentText, timestamp: lastUpdateTimestamp, creationTime: creationTime });
        } else if(data.type === "update"){
          // Accept update only if the timestamp is newer.
          if(data.timestamp > lastUpdateTimestamp){
            currentText = data.text;
            lastUpdateTimestamp = data.timestamp;
            updateTextArea(currentText);
            updateLastUpdateDisplay(lastUpdateTimestamp);
            // Broadcast this update to all connected clients.
            broadcastUpdate(data);
          }
        }
      }

      // Client: Handle data received from the host.
      function handleClientData(data){
        if(data.type === "init"){
          currentText = data.text;
          lastUpdateTimestamp = data.timestamp;
          creationTime = data.creationTime;
          updateTextArea(currentText);
          updateLastUpdateDisplay(lastUpdateTimestamp);
        } else if(data.type === "update"){
          if(data.timestamp > lastUpdateTimestamp){
            currentText = data.text;
            lastUpdateTimestamp = data.timestamp;
            updateTextArea(currentText);
            updateLastUpdateDisplay(lastUpdateTimestamp);
          }
        } else if(data.type === "error"){
          alert("Error: " + data.message);
        }
      }

      // Host: Broadcast an update message to all connected clients.
      function broadcastUpdate(data){
        connections.forEach(function(conn){
          if(conn.open){
            conn.send(data);
          }
        });
      }

      // Update the textarea content without triggering an input event.
      function updateTextArea(text){
        isUpdating = true;
        textArea.value = text;
        isUpdating = false;
      }

      // Update the "Last update" display.
      function updateLastUpdateDisplay(timestamp){
        if(timestamp){
          var date = new Date(timestamp);
          lastUpdateElem.textContent = "Last update: " + date.toLocaleString();
        } else {
          lastUpdateElem.textContent = "Last update: N/A";
        }
      }

      // Debounce text input so that updates aren’t sent on every keystroke.
      textArea.addEventListener("input", function(){
        if(isUpdating) return;
        if(updateTimeout) clearTimeout(updateTimeout);
        updateTimeout = setTimeout(handleTextUpdate, 500);
      });

      // Called after debouncing – send the update.
      function handleTextUpdate(){
        var text = textArea.value;
        var timestamp = Date.now();
        if(text === currentText) return;
        currentText = text;
        lastUpdateTimestamp = timestamp;
        updateLastUpdateDisplay(timestamp);
        var data = { type: "update", text: text, timestamp: timestamp };
        if(mode === "host"){
          broadcastUpdate(data);
        } else if(mode === "client" && conn && conn.open){
          conn.send(data);
        }
      }

      // Clear button: clear the textarea and update.
      clearBtn.addEventListener("click", function(){
        textArea.value = "";
        handleTextUpdate();
      });

      // Copy button: copy textarea contents to the clipboard.
      copyBtn.addEventListener("click", function(){
        navigator.clipboard.writeText(textArea.value).then(function(){
          alert("Text copied to clipboard!");
        });
      });

      // Every second, update the time remaining until the room expires.
      setInterval(function(){
        if(!creationTime) return;
        var elapsed = Date.now() - creationTime;
        var remaining = 24 * 60 * 60 * 1000 - elapsed;
        if(remaining <= 0){
          timeRemainingElem.textContent = "Room expired";
          textArea.disabled = true;
          if(peer && !peer.destroyed){
            peer.destroy();
          }
        } else {
          var hours = Math.floor(remaining / (1000 * 60 * 60));
          var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          var seconds = Math.floor((remaining % (1000 * 60)) / 1000);
          timeRemainingElem.textContent = "Time remaining: " + hours + "h " + minutes + "m " + seconds + "s";
        }
      }, 1000);

    })();
  </script>
</body>
</html>
